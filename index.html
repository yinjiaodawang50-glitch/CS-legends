<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CS LEGENDS v6.0</title>
<!--
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  CS LEGENDS v6.0 â€” ç‰¹è´¨ç³»ç»Ÿæ·±åº¦é‡æ„ç‰ˆ
  åŸºäº v5.0 å…¨é¢ä¿®å¤ç‰ˆï¼Œæœ¬ç‰ˆæ ¸å¿ƒå‡çº§ï¼š

  ã€ä¸‰çº§ç‰¹è´¨åº“æ¶æ„ã€‘
  A. å¸¸è§„ç‰¹è´¨ï¼ˆNORMAL_TRAITSï¼‰â€”â€” è·¯äººé€‰æ‰‹ 20% æ¦‚ç‡è·å¾— 1 ä¸ª
     Â· çˆ†å¤´æœºå™¨ï¼šæ­¥æªå±€å‡»æ€æƒé‡+15%ï¼›æ—¥å¿—ä¸­çˆ†å¤´å‡»æ€é‡‘è‰²é«˜äº®
     Â· å¤§å¿ƒè„ï¼š  æ®‹å±€1vX Clutch æˆåŠŸç‡+40%ï¼Œå¿…å®šä¸Šæ—¥å¿—
     Â· ç¥ç»åˆ€ï¼š  æ¯å›åˆæˆ˜åŠ›ä¹˜ä»¥ 0.75~1.35 éšæœºæµ®åŠ¨
     Â· é¢†è¢–ï¼š    IGLä¸Šåœºæ—¶å…¨é˜Ÿæˆ˜åŠ›+4%ï¼Œé¦–æ¬¡è§¦å‘æ—¥å¿—æ’­æŠ¥

  B. é€šç”¨ä¼ å¥‡ç‰¹è´¨ï¼ˆGENERIC_LEGEND_TRAITSï¼‰â€”â€” ä»… Regen Legendï¼ˆ0.5%ï¼‰å¯æŠ½å–
     Â· ç»å¯¹æ ¸å¿ƒï¼š1vXæ®‹å±€æ—¶æˆ˜åŠ›+20%ï¼Œå¿…å®š Clutchï¼Œé‡‘å­—æ’­æŠ¥
     Â· å¤©ç”Ÿèµ¢å®¶ï¼šåŠ/å†³èµ›èµ›åRatingå¼ºåˆ¶â‰¥1.10ï¼Œé‡‘å­—æ’­æŠ¥

  C. å†å²ä¸“å±ç­¾åç‰¹è´¨ï¼ˆSIGNATURE_TRAITSï¼‰â€”â€” å”¯ä¸€ç»‘å®šçœŸå®é€‰æ‰‹
     Â· å¤©å¤–é£ä»™ï¼ˆs1mpleï¼‰ï¼šè½åâ‰¥4åˆ†æ—¶æˆ˜åŠ›+20%ï¼Œå¤šæ€æ¦‚ç‡ç¿»å€ï¼Œé‡‘å­—æ’­æŠ¥
     Â· è½½ç‰©é¢†åŸŸï¼ˆZyWoOï¼‰ï¼š  å…è´Ÿé¢çŠ¶æ€ï¼Œæ‰‹æªå±€ä¸æŠ˜æ‰£ï¼Œ1vX+55%ï¼Œé‡‘å­—æ’­æŠ¥
     Â· æˆ˜æœ¯å¤§è„‘ï¼ˆkarrigan/gla1veï¼‰ï¼šæ— è§†Synergyæƒ©ç½šï¼Œå…¨é˜ŸÃ—1.1ï¼ŒBPé¢å¤–æ•ˆæœ
     Â· ä¸è€ç¥è¯ï¼ˆf0restï¼‰ï¼š30å²åæ°¸ä¸ä¸‹æ»‘

  ã€HISTORICAL_DATA æ·±åº¦ç»‘å®šã€‘
  Â· æ¯ä¸ªçœŸå®é€‰æ‰‹åœ¨ HISTORICAL_DATA é…ç½® signatureTrait + normalTraits
  Â· mkRealPlayer è‡ªåŠ¨è£…å¤‡ç­¾åç‰¹è´¨ + é¢„è®¾å¸¸è§„ç‰¹è´¨ï¼Œæ— éœ€ while å¾ªç¯
  Â· debutYear ç™»åœºé€‰æ‰‹åŒæ ·èµ° mkRealPlayer æµç¨‹ï¼Œç‰¹è´¨100%æ­£ç¡®

  ã€mkP é‡æ„ã€‘
  Â· AI é€‰æ‰‹ï¼š0% ç‰¹è´¨æ¦‚ç‡ï¼ˆAIæ— ç‰¹è´¨ï¼Œç®€åŒ–é€»è¾‘ï¼‰
  Â· è·¯äººé€‰æ‰‹ï¼š20% è·å¾— 1 ä¸ªå¸¸è§„ç‰¹è´¨
  Â· Regen Legendï¼ˆ0.5%ï¼‰ï¼š1 ä¸ªé€šç”¨ä¼ å¥‡ç‰¹è´¨ + 2 ä¸ªå¸¸è§„ç‰¹è´¨ï¼Œé‡‘è‰²è¾¹æ¡†

  ã€æ¯”èµ›å¼•æ“é›†æˆã€‘
  Â· calcTraitMultï¼šç²¾å‡†é€å±‚å¤„ç†æ‰€æœ‰ç‰¹è´¨æ•ˆæœ
  Â· _microï¼šå¤§å¿ƒè„/ç»å¯¹æ ¸å¿ƒ/è½½ç‰©é¢†åŸŸ/çˆ†å¤´æœºå™¨åœ¨æ®‹å±€åœºæ™¯ç‰¹æ®Šåˆ¤å®š
  Â· end()ï¼šå¤©ç”Ÿèµ¢å®¶åœ¨èµ›åRatingç»“ç®—è§¦å‘ï¼Œé‡‘å­—æ’­æŠ¥
  Â· æ‰€æœ‰ä¼ å¥‡/ç­¾åç‰¹è´¨ç”¨é‡‘è‰²å­—ä½“+ä¸“å±å‰ç¼€ [â˜…ç­¾å]/[âœ¦ä¼ å¥‡] åŒºåˆ†
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-->
<style>
:root{
  --bg:#09090b;--panel:#111114;--panel2:#18181c;--border:#2a2a30;--hover:#222228;
  --gold:#e8a838;--gold2:#ffc15e;--gold-dim:#6b4a12;
  --fg:#dddde0;--dim:#666672;--dim2:#444450;
  --win:#4caf50;--loss:#ef4444;--blue:#3b82f6;--purple:#a855f7;
  --ct:#6272ea;--t:#f59e0b;
  --mvp:#ffd700;--evp:#b0b0c0;
  --map-str:#22c55e;--map-weak:#ef4444;--map-mid:#f59e0b;
}
*{box-sizing:border-box;margin:0;padding:0;user-select:none}
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--fg);height:100vh;display:flex;overflow:hidden;font-size:14px}
.sb{width:232px;background:#0d0d10;border-right:1px solid var(--border);display:flex;flex-direction:column;padding:20px 16px;z-index:100;flex-shrink:0}
.logo{font-size:17px;font-weight:800;color:var(--gold);margin-bottom:20px;letter-spacing:.5px;display:flex;align-items:center;gap:8px}
.logo span{font-size:10px;color:var(--dim);font-weight:400;letter-spacing:1px;background:var(--panel2);padding:2px 6px;border-radius:3px;border:1px solid var(--border)}
.timebox{background:var(--panel2);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:16px;text-align:center}
.timedate{font-size:17px;font-weight:700;color:#fff;font-family:Consolas,monospace;letter-spacing:1px}
.era-tag{font-size:11px;color:var(--dim);margin:4px 0 10px;letter-spacing:.5px}
.tbtn{display:block;width:100%;background:var(--gold);color:#000;border:none;padding:7px;font-weight:700;border-radius:5px;cursor:pointer;margin-bottom:5px;font-size:12px;transition:.15s;letter-spacing:.3px}
.tbtn:hover{background:var(--gold2)}
.tbtn.dim{background:var(--panel2);color:var(--dim);border:1px solid var(--border)}
.tbtn.dim:hover{background:var(--hover);color:var(--fg)}
.nav{display:flex;align-items:center;gap:10px;background:transparent;border:none;color:var(--dim);text-align:left;padding:9px 12px;cursor:pointer;border-radius:6px;font-size:13px;font-weight:600;margin-bottom:3px;transition:.15s;width:100%}
.nav:hover,.nav.on{background:var(--hover);color:var(--fg);border-left:3px solid var(--gold);padding-left:9px}
.statbar{margin-top:auto;border-top:1px solid var(--border);padding-top:14px;font-size:12px;color:var(--dim)}
.srow{display:flex;justify-content:space-between;margin-bottom:7px;align-items:center}
.sval{color:var(--fg);font-weight:600;font-family:Consolas,monospace}
.main{flex:1;padding:28px 36px;overflow-y:auto;overflow-x:hidden}
.hdr{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:22px}
.hdr h1{font-size:22px;font-weight:700;margin-bottom:4px}
.hdr p{color:var(--dim);font-size:12px}
.panel{background:var(--panel);border-radius:10px;padding:22px;margin-bottom:20px;border:1px solid var(--border)}
.panel-title{font-size:14px;font-weight:700;color:#fff;border-bottom:1px solid var(--border);padding-bottom:10px;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center;letter-spacing:.3px}
.g2{display:grid;grid-template-columns:1.8fr 1fr;gap:18px}
.gcards{display:grid;grid-template-columns:repeat(auto-fill,minmax(168px,1fr));gap:12px}
.card{background:var(--panel2);border:1px solid var(--border);border-radius:8px;padding:14px;transition:.2s;position:relative;cursor:default}
.card:hover{border-color:var(--gold-dim);background:#1c1c22}
.card.coach-card{border-color:#1e2a40;background:#111620}
.card.coach-card:hover{border-color:#2a4a7a}
.rbadge{font-size:9px;font-weight:700;padding:2px 6px;border-radius:3px;color:#fff;position:absolute;top:10px;right:10px;letter-spacing:.5px}
.cname{font-size:14px;font-weight:700;color:#fff;margin:4px 0 10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding-right:60px}
.cstat{font-size:11px;color:var(--dim);display:flex;justify-content:space-between;margin-bottom:5px;align-items:center}
.cstat b{color:var(--fg);font-family:Consolas,monospace}
.mapbars{margin-top:8px;padding-top:8px;border-top:1px solid var(--border)}
.mapbar-row{display:flex;align-items:center;gap:6px;margin-bottom:4px;font-size:10px}
.mapbar-name{width:52px;color:var(--dim);flex-shrink:0}
.mapbar-bg{flex:1;height:4px;background:var(--border);border-radius:2px;overflow:hidden}
.mapbar-fill{height:100%;border-radius:2px;transition:.3s}
.potbox{background:#111;border-radius:4px;padding:5px;margin-top:8px;text-align:center;border:1px solid var(--border)}
.potval{font-size:17px;font-weight:900;font-family:Consolas,monospace}
.age-warn{font-size:10px;color:var(--loss);margin-top:4px}
.btn{background:var(--gold);color:#000;border:none;border-radius:5px;padding:6px 14px;font-weight:700;cursor:pointer;font-size:12px;transition:.15s;letter-spacing:.3px}
.btn:hover{background:var(--gold2)}
.btn.danger{background:#3a1212;color:var(--loss);border:1px solid #5a1c1c}
.btn.danger:hover{background:#4a1818}
.btn.dark{background:var(--panel2);color:var(--dim);border:1px solid var(--border)}
.btn.dark:hover{background:var(--hover);color:var(--fg)}
.btn.full{width:100%;margin-top:8px;padding:7px}
.cev{display:flex;align-items:center;gap:14px;padding:11px 14px;background:var(--panel2);border-left:3px solid var(--border);margin-bottom:8px;border-radius:5px;transition:.15s}
.cev.major{border-left-color:var(--mvp);background:rgba(255,215,0,.04)}
.cev.atier{border-left-color:var(--blue)}
.cev.ctier{border-left-color:var(--dim2)}
.cev-date{font-family:Consolas,monospace;color:var(--dim);font-size:12px;width:55px;flex-shrink:0}
.cev-body{flex:1}
.cev-name{font-weight:700;font-size:14px}
.cev-sub{font-size:11px;color:var(--dim);margin-top:2px}
.bo-tag{font-size:10px;padding:2px 7px;border-radius:3px;font-weight:700;margin-left:8px}
.bo-bo1{background:#1a2a1a;color:#4caf50}
.bo-bo3{background:#1a1a2a;color:#3b82f6}
.bo-bo5{background:#2a1a2a;color:#a855f7}
.trbtns{display:flex;gap:8px;margin-bottom:10px}
.trbtn{flex:1;padding:9px 6px;background:var(--panel2);border:1px solid var(--border);color:var(--dim);cursor:pointer;border-radius:5px;font-size:12px;font-weight:700;transition:.15s;text-align:center}
.trbtn.on{background:var(--gold);color:#000;border-color:var(--gold)}
.scoreboard{font-size:52px;font-weight:900;margin:14px 0;display:flex;justify-content:center;align-items:center;gap:36px}
.mlog{height:240px;overflow-y:auto;background:#060608;border:1px solid var(--border);padding:12px;font-family:Consolas,monospace;font-size:12px;margin-bottom:16px;border-radius:6px;text-align:left}
.mlog-e{margin-bottom:5px;padding-left:10px;border-left:2px solid var(--border)}
.mlog-e.win{border-left-color:var(--win);color:#86efac}
.mlog-e.loss{border-left-color:var(--loss);color:#fca5a5}
.mlog-e.spec{border-left-color:var(--gold);color:var(--gold);font-weight:700}
.mlog-e.eco{border-left-color:var(--blue);color:#93c5fd;font-style:italic}
.mlog-e.event{border-left-color:var(--purple);color:#d8b4fe;font-size:11px}
.bct{background:var(--ct);color:#fff;padding:2px 7px;border-radius:3px;font-size:11px;font-weight:700}
.bt{background:var(--t);color:#000;padding:2px 7px;border-radius:3px;font-size:11px;font-weight:700}
.ot-badge{background:linear-gradient(90deg,#f59e0b,#e8a838);color:#000;font-size:10px;font-weight:900;padding:2px 8px;border-radius:3px;animation:pulse 1s ease-in-out infinite alternate}
@keyframes pulse{from{opacity:.6}to{opacity:1}}
.stbl{width:100%;border-collapse:collapse;font-size:12px;text-align:center}
.stbl th{background:#1a1a1e;color:var(--dim);padding:8px 5px;font-weight:700;border-bottom:1px solid var(--border);text-transform:uppercase;font-size:10px;letter-spacing:.5px}
.stbl td{padding:8px 5px;border-bottom:1px solid #1a1a1e}
.stbl tr:hover td{background:#1c1c22}
.stbl td:first-child{text-align:left;font-weight:700;color:#eee}
.g{color:var(--win);font-weight:700}
.r{color:var(--loss);font-weight:700}
.bmvp{background:rgba(255,215,0,.12);color:var(--mvp);border:1px solid rgba(255,215,0,.3);padding:1px 5px;border-radius:3px;font-size:9px;margin-left:4px}
.bevp{background:rgba(192,192,192,.1);color:var(--evp);border:1px solid rgba(192,192,192,.2);padding:1px 5px;border-radius:3px;font-size:9px;margin-left:4px}
.bcol{display:flex;flex-direction:column;justify-content:space-around;gap:14px;min-width:200px}
.bnode{background:var(--panel2);padding:10px 13px;border:1px solid var(--border);border-radius:7px;font-size:12px}
.bnode.pnode{border-color:var(--gold-dim);box-shadow:0 0 12px rgba(232,168,56,.15)}
.bteam{padding:5px 0;font-weight:600;color:var(--dim);display:flex;justify-content:space-between}
.bteam.won{color:#fff}
.bteam.isp{color:var(--blue)}
.bteam.isp.won{color:var(--win)}
.bscore{font-family:Consolas,monospace;font-size:13px;font-weight:700}
.mapgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:8px;margin-top:10px}
.mapchip{background:var(--panel2);border:1px solid var(--border);border-radius:6px;padding:8px 10px;font-size:12px;font-weight:600;position:relative;overflow:hidden}
.mapchip .str-bar{position:absolute;bottom:0;left:0;height:3px;border-radius:0 0 0 6px}
.mapchip.str-high{border-color:rgba(34,197,94,.3)}
.mapchip.str-mid{border-color:rgba(245,158,11,.3)}
.mapchip.str-low{border-color:rgba(239,68,68,.3)}
.maptag{font-size:9px;margin-top:3px}
#bp-overlay{position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:500;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:30px}
.bp-title{font-size:22px;font-weight:800;color:var(--gold);margin-bottom:6px;letter-spacing:.5px}
.bp-sub{font-size:13px;color:var(--dim);margin-bottom:22px}
.bp-phase{font-size:12px;font-weight:700;color:var(--fg);background:var(--panel2);border:1px solid var(--border);padding:5px 16px;border-radius:20px;margin-bottom:18px;letter-spacing:.5px}
.bp-maps{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;max-width:820px;margin-bottom:20px}
.bp-map{background:var(--panel2);border:2px solid var(--border);border-radius:8px;padding:12px 16px;cursor:pointer;transition:.18s;min-width:110px;text-align:center;position:relative}
.bp-map:hover:not(.banned):not(.picked-p):not(.picked-ai):not(.decider):not(.disabled){border-color:var(--gold);background:#1e1e10;transform:translateY(-2px)}
.bp-map.banned{opacity:.3;cursor:not-allowed;text-decoration:line-through}
.bp-map.picked-p{border-color:var(--win);background:rgba(34,197,94,.08)}
.bp-map.picked-ai{border-color:var(--loss);background:rgba(239,68,68,.08)}
.bp-map.decider{border-color:var(--purple);background:rgba(168,85,247,.08)}
.bp-map.disabled{cursor:not-allowed}
.bp-map-name{font-size:14px;font-weight:700;margin-bottom:5px}
.bp-map-bars{display:flex;gap:4px;justify-content:center;margin-top:6px}
.bp-bar{height:5px;width:40px;border-radius:2px}
.bp-legend{display:flex;gap:18px;font-size:11px;color:var(--dim);margin-bottom:16px}
.bp-legend span{display:flex;align-items:center;gap:5px}
.bp-legend .dot{width:8px;height:8px;border-radius:50%}
.bp-status{display:flex;gap:30px;margin-bottom:16px}
.bp-team{text-align:center;min-width:180px}
.bp-team-name{font-size:13px;font-weight:700;margin-bottom:6px}
.bp-picks-row{display:flex;gap:6px;justify-content:center;flex-wrap:wrap}
.bp-pick-slot{width:90px;height:28px;border:1px dashed var(--border);border-radius:4px;font-size:11px;display:flex;align-items:center;justify-content:center;color:var(--dim)}
.bp-pick-slot.filled-win{border-color:var(--win);background:rgba(34,197,94,.1);color:var(--win);font-weight:700}
.bp-pick-slot.filled-loss{border-color:var(--loss);background:rgba(239,68,68,.1);color:var(--loss);font-weight:700}
.bp-pick-slot.filled-decider{border-color:var(--purple);background:rgba(168,85,247,.1);color:var(--purple);font-weight:700}
.series-bar{display:flex;gap:10px;justify-content:center;margin-bottom:16px;align-items:center;flex-wrap:wrap}
.series-map-btn{padding:6px 14px;border-radius:5px;font-size:12px;font-weight:700;border:1px solid var(--border);background:var(--panel2);color:var(--dim)}
.series-map-btn.active{border-color:var(--gold);color:var(--gold);background:rgba(232,168,56,.08)}
.series-map-btn.won-p{border-color:var(--win);color:var(--win);background:rgba(34,197,94,.08)}
.series-map-btn.won-ai{border-color:var(--loss);color:var(--loss);background:rgba(239,68,68,.08)}
.arow{display:flex;justify-content:space-between;align-items:center;padding:11px 14px;background:var(--panel2);border-radius:6px;margin-bottom:8px;border-left:3px solid var(--border)}
.arow.mvp-row{background:linear-gradient(90deg,rgba(232,168,56,.12),transparent);border-left-color:var(--mvp)}
.arow.evp-row{border-left-color:var(--evp)}
.tab-row{display:flex;gap:0;margin-bottom:16px;border-bottom:1px solid var(--border)}
.tab{padding:8px 20px;cursor:pointer;font-size:13px;font-weight:600;color:var(--dim);border-bottom:2px solid transparent;transition:.15s;margin-bottom:-1px}
.tab.on{color:var(--gold);border-bottom-color:var(--gold)}
#hltv-modal{position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:1000;display:flex;flex-direction:column;align-items:center;padding:40px;overflow-y:auto}
.hrow{display:flex;align-items:center;background:#111;border:1px solid var(--border);margin-bottom:7px;padding:13px;border-radius:6px}
.hrank{font-size:22px;font-weight:900;color:#333;width:46px;text-align:center;font-style:italic;font-family:Consolas,monospace}
.hrow.top3 .hrank{color:var(--mvp)}
.hidden{display:none!important}
.toast{position:fixed;bottom:22px;right:22px;background:#18181e;color:#fff;padding:12px 22px;border-radius:7px;border-left:4px solid var(--gold);z-index:2000;box-shadow:0 8px 24px rgba(0,0,0,.6);font-weight:600;font-size:13px;pointer-events:none}
.event-ticker{position:fixed;bottom:22px;left:250px;right:280px;background:rgba(168,85,247,.12);border:1px solid rgba(168,85,247,.3);color:#d8b4fe;padding:8px 16px;border-radius:6px;font-size:12px;z-index:1999;text-align:center;pointer-events:none}
.syn{margin-bottom:7px;padding-left:9px;border-left:2px solid var(--border);font-size:12px}
.intel-row{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid var(--border);font-size:12px}
.intel-row:last-child{border-bottom:none}
/* ç‰¹è´¨å¾½ç« åˆ†çº§æ ·å¼ */
.trait-normal{font-size:9px;padding:2px 5px;border-radius:3px;margin-right:3px;font-weight:700;display:inline-block}
.trait-legend{font-size:9px;padding:2px 5px;border-radius:3px;margin-right:3px;font-weight:700;display:inline-block;animation:traitPulse 2s ease-in-out infinite alternate}
.trait-sig{font-size:9px;padding:2px 5px;border-radius:3px;margin-right:3px;font-weight:700;display:inline-block;animation:sigShimmer 3s linear infinite}
@keyframes traitPulse{from{box-shadow:0 0 4px rgba(255,215,0,0.4)}to{box-shadow:0 0 10px rgba(255,215,0,0.9)}}
@keyframes sigShimmer{0%{filter:brightness(1)}50%{filter:brightness(1.4)}100%{filter:brightness(1)}}
/* ä¼ å¥‡é€‰æ‰‹å¡ç‰‡ï¼šé¢å¤–é‡‘è‰²è„‰å†² */
.card.regen-legend{animation:legendCardPulse 3s ease-in-out infinite alternate}
@keyframes legendCardPulse{from{box-shadow:0 0 6px rgba(255,215,0,0.2)}to{box-shadow:0 0 18px rgba(255,215,0,0.55)}}
/* æ¯”èµ›æ—¥å¿—ï¼šç­¾åç‰¹è´¨è§¦å‘ä¸“ç”¨ */
.mlog-e.sig-trigger{border-left-color:#ff9500;color:#ffd700;font-weight:700;background:rgba(255,215,0,0.06)}
.mlog-e.legend-trigger{border-left-color:#a78bfa;color:#c4b5fd;font-weight:700;background:rgba(167,139,250,0.06)}
</style>
</head>
<body>

<div class="sb">
  <div class="logo">CS LEGENDS <span>v6.0</span></div>
  <div class="timebox">
    <div class="timedate" id="ui-date">2000-01-01</div>
    <div class="era-tag" id="ui-era">CS 1.6 Era</div>
    <button class="tbtn" onclick="Game.advanceDay()">æ¨è¿› 1 å¤© â”</button>
    <button class="tbtn dim" onclick="Game.skipToEvent()">â­ è·³è‡³ä¸‹ä¸ªèµ›äº‹</button>
  </div>
  <button class="nav on" onclick="UI.page('home')">ğŸ¢ ä¿±ä¹éƒ¨æ€»éƒ¨</button>
  <button class="nav" onclick="UI.page('schedule')">ğŸ“… èµ›äº‹æ—¥å†</button>
  <button class="nav" onclick="UI.page('market')">ğŸ›’ è½¬ä¼šå¸‚åœº</button>
  <button class="nav" onclick="UI.page('match')">ğŸ”« èµ›äº‹ä¸­å¿ƒ</button>
  <button class="nav" onclick="UI.page('hall')">ğŸ† è£èª‰å®¤</button>
  <div style="flex:1"></div>
  <button class="nav" style="color:var(--gold)" onclick="SaveManager.save()">ğŸ’¾ ä¿å­˜æ¸¸æˆ</button>
  <button class="nav" style="color:var(--loss)" onclick="if(confirm('ç¡®å®šåˆ æ¡£é‡ç½®ï¼Ÿ')){localStorage.removeItem(SaveManager.key);location.reload();}">âš  åˆ æ¡£é‡ç½®</button>
  <div class="statbar">
    <div style="font-size:11px;font-weight:700;color:var(--dim);margin-bottom:6px;letter-spacing:.5px">NEWS TICKER</div>
    <div id="news-ticker" style="height:80px;overflow-y:auto;font-size:10px;color:var(--dim2);margin-bottom:10px;line-height:1.4"></div>
    <div class="srow"><span>èµ„é‡‘</span><span class="sval" id="ui-money">$5,000</span></div>
    <div class="srow"><span>å‘¨è–ª</span><span class="sval" id="ui-salary" style="color:var(--loss)">$0</span></div>
    <div class="srow"><span>ç²‰ä¸</span><span class="sval" id="ui-fans">100</span></div>
    <div class="srow"><span>èµ›å­£</span><span class="sval" id="ui-season">2000</span></div>
  </div>
</div>

<div class="main">

<div id="page-home">
  <div class="hdr">
    <div><h1>ä¿±ä¹éƒ¨æ€»éƒ¨</h1><p>ç®¡ç†é˜µå®¹ã€æ•™ç»ƒä¸æ—¥å¸¸è®­ç»ƒ</p></div>
  </div>
  <div class="g2">
    <div>
      <div class="panel">
        <div class="panel-title">é¦–å‘é˜µå®¹ï¼ˆ5äººï¼‰<span style="font-size:11px;color:var(--dim);font-weight:400">è®­ç»ƒå¯å‘æ½œåŠ›ä¸Šé™é æ‹¢</span></div>
        <div id="roster-container" class="gcards"></div>
      </div>
      <div class="panel">
        <div class="panel-title">æ•™ç»ƒå¸­<span style="font-size:11px;color:var(--blue);font-weight:400">å½±å“BPç²¾å‡†åº¦ä¸ç£¨åˆä¸Šé™</span></div>
        <div id="coach-container"></div>
      </div>
    </div>
    <div style="display:flex;flex-direction:column;gap:16px">
      <div class="panel" style="margin-bottom:0">
        <div class="panel-title">æˆ˜é˜ŸçŠ¶æ€</div>
        <div class="srow"><span style="color:var(--dim)">çº¸é¢æˆ˜åŠ›</span><strong id="ui-raw" style="font-family:Consolas">â€”</strong></div>
        <div class="srow" style="margin-bottom:10px"><span style="color:var(--dim)">å®é™…æˆ˜æ–—åŠ›</span><strong id="ui-eff" style="font-size:18px;color:var(--win);font-family:Consolas">â€”</strong></div>
        <div class="srow"><span style="color:var(--dim)">ç£¨åˆåº¦</span><strong id="ui-chem" style="color:var(--blue);font-family:Consolas">â€”</strong></div>
        <div class="srow"><span style="color:var(--dim)">ç£¨åˆä¸Šé™</span><strong id="ui-chem-max" style="color:var(--dim);font-family:Consolas">100</strong></div>
        <div class="srow"><span style="color:var(--dim)">ç–²åŠ³å€¼</span><strong id="ui-fatigue" style="color:var(--loss);font-family:Consolas">â€”</strong></div>
      </div>
      <div class="panel" style="margin-bottom:0">
        <div class="panel-title">Synergy è¯„ä¼°</div>
        <div id="ui-syn" style="background:#0d0d10;padding:12px;border-radius:5px;border:1px solid var(--border)"></div>
      </div>
      <div class="panel" style="margin-bottom:0">
        <div class="panel-title">é˜Ÿä¼å›¾æ± å¼ºåº¦</div>
        <div id="ui-mappool" class="mapgrid"></div>
      </div>
      <div class="panel" style="margin-bottom:0">
        <div class="panel-title">æ—¥å¸¸è®­ç»ƒ</div>
        <div class="trbtns">
          <button class="trbtn on" id="tr-rest" onclick="Game.setTrain('rest')">ğŸ›Œ ä¼‘æ¯</button>
          <button class="trbtn" id="tr-aim" onclick="Game.setTrain('aim')">ğŸ¯ æ­»æ–—</button>
          <button class="trbtn" id="tr-tactics" onclick="Game.setTrain('tactics')">ğŸ—º æˆ˜æœ¯</button>
        </div>
        <div style="font-size:11px;color:var(--dim)" id="tr-desc">æ¢å¤ä½“åŠ›ä¸çŠ¶æ€ï¼Œé™ä½ç–²åŠ³ã€‚</div>
      </div>
    </div>
  </div>
</div>

<div id="page-schedule" class="hidden">
  <div class="hdr"><div><h1>å¹´åº¦èµ›äº‹æ—¥å†</h1><p>æŠ¥åå‚èµ›ï¼Œèµ¢å–å¥–é‡‘ä¸ç²‰ä¸</p></div></div>
  <div class="panel"><div id="cal-container"></div></div>
</div>

<div id="page-market" class="hidden">
  <div class="hdr">
    <div><h1>è½¬ä¼šå¸‚åœº</h1><p>ç­¾çº¦é€‰æ‰‹ä¸æ•™ç»ƒï¼Œæ³¨æ„å¹´é¾„ä¸æ½œåŠ›</p></div>
    <button class="btn" onclick="Market.refresh()">ğŸ”„ åˆ·æ–°åå•ï¼ˆ$500ï¼‰</button>
  </div>
  <div class="panel">
    <div class="tab-row">
      <div class="tab on" id="tab-players" onclick="Market.showTab('players')">é€‰æ‰‹</div>
      <div class="tab" id="tab-coaches" onclick="Market.showTab('coaches')">æ•™ç»ƒ</div>
    </div>
    <div id="market-players" class="gcards" style="grid-template-columns:repeat(auto-fill,minmax(200px,1fr))"></div>
    <div id="market-coaches" class="gcards hidden" style="grid-template-columns:repeat(auto-fill,minmax(220px,1fr))"></div>
  </div>
</div>

<div id="page-hall" class="hidden">
  <div class="hdr"><div><h1>è£èª‰å®¤</h1><p>è§è¯æˆ˜é˜Ÿçš„è¾‰ç…Œæ—¶åˆ»ä¸ä¼ å¥‡å†ç¨‹</p></div></div>
  <div class="panel">
    <div class="panel-title">å† å†›å¥–æ¯é™ˆåˆ—</div>
    <div id="trophy-case" class="gcards" style="grid-template-columns:repeat(auto-fill,minmax(200px,1fr))"></div>
  </div>
</div>

<div id="page-match" class="hidden">
  <div class="hdr"><h1>èµ›äº‹ä¸­å¿ƒ</h1></div>
  <div class="panel" id="pnl-empty">
    <div style="text-align:center;padding:40px;color:var(--dim)">
      <div style="font-size:36px;margin-bottom:12px">ğŸ“…</div>
      <h3 style="margin-bottom:8px">å½“å‰æ²¡æœ‰æ­£åœ¨è¿›è¡Œçš„æ¯”èµ›</h3>
      <p style="font-size:12px">å‰å¾€èµ›äº‹æ—¥å†æŠ¥åï¼Œæ¨è¿›æ—¶é—´è‡³æ¯”èµ›æ—¥</p>
    </div>
  </div>
  <div id="pnl-hub" class="hidden">
    <div class="panel" style="border-color:var(--gold-dim)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
        <div>
          <div id="hub-name" style="font-size:20px;font-weight:800;color:var(--gold)"></div>
          <div id="hub-desc" style="font-size:12px;color:var(--dim);margin-top:3px"></div>
        </div>
        <button class="btn dark" onclick="Tour.quit()">å¼ƒèµ›ç¦»åœº</button>
      </div>
      <div id="bracket" style="display:flex;gap:16px;overflow-x:auto;padding:10px 0"></div>
    </div>
    <div class="panel" id="pnl-next">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
        <div>
          <div style="font-size:12px;color:var(--dim);margin-bottom:4px">ä¸‹ä¸€åœºå¯¹æ‰‹</div>
          <div style="font-size:18px;font-weight:700" id="hub-opp">â€”</div>
          <div style="font-size:11px;color:var(--dim);margin-top:3px" id="hub-format">BO1</div>
        </div>
        <div id="hub-intel" style="flex:1;max-width:360px;background:var(--panel2);border:1px solid var(--border);border-radius:7px;padding:12px">
          <div style="font-size:11px;font-weight:700;color:var(--dim);margin-bottom:8px;letter-spacing:.5px">èµ›å‰æƒ…æŠ¥</div>
          <div id="intel-content"></div>
        </div>
        <button class="btn" style="padding:13px 30px;font-size:15px" onclick="BP.start()">è¿›å…¥å›¾æ± BP âš”</button>
      </div>
    </div>
  </div>

  <div id="pnl-live" class="panel hidden">
    <div style="text-align:center">
      <div class="series-bar" id="series-bar"></div>
      <h3 id="live-title" style="color:var(--gold);margin-bottom:8px;font-size:17px"></h3>
      <div class="scoreboard">
        <div style="text-align:right;flex:1">
          <div style="font-size:13px;color:#fff;margin-bottom:6px"><span id="badge-a" class="bct">CT</span> æˆ‘çš„æˆ˜é˜Ÿ</div>
          <span id="score-a" style="color:var(--win)">0</span>
          <div id="eco-a" style="font-size:12px;margin-top:10px;color:var(--dim)"></div>
        </div>
        <div style="color:var(--border);font-size:36px;position:relative">
          :
          <div id="ot-ind" class="hidden" style="position:absolute;top:-20px;left:50%;transform:translateX(-50%)"><span class="ot-badge">OT</span></div>
        </div>
        <div style="text-align:left;flex:1">
          <div style="font-size:13px;color:#fff;margin-bottom:6px"><span id="badge-b" class="bt">T</span> <span id="live-opp"></span></div>
          <span id="score-b" style="color:var(--loss)">0</span>
          <div id="eco-b" style="font-size:12px;margin-top:10px;color:var(--dim)"></div>
        </div>
      </div>
      <div class="mlog" id="matchlog"></div>
      <div id="live-ctrl">
        <button class="btn" onclick="Match.round()">âš” ä¸‹ä¸€å›åˆ</button>
        <button class="btn dark" style="margin-left:12px" onclick="Match.auto()">â­ å¿«é€Ÿæ¨¡æ‹Ÿ</button>
      </div>
      <div id="post-stats" class="hidden" style="text-align:left;margin-top:18px;border-top:1px solid var(--border);padding-top:18px">
        <h3 style="margin-bottom:12px;font-size:16px">ğŸ“Š èµ›åæ•°æ®ï¼ˆHLTV Rating 2.0ï¼‰</h3>
        <div id="match-awards" style="margin-bottom:16px;padding:13px;background:var(--panel2);border-radius:6px;border:1px solid var(--border)"></div>
        <div style="display:flex;gap:16px;flex-wrap:wrap">
          <div style="flex:1;min-width:320px;background:#0e0e12;border-radius:7px;overflow:hidden">
            <div style="background:#1a2a1a;padding:7px 13px;font-weight:700;color:#86efac;font-size:12px">ğŸ›¡ æˆ‘çš„æˆ˜é˜Ÿ</div>
            <table class="stbl" id="tbl-a"></table>
          </div>
          <div style="flex:1;min-width:320px;background:#0e0e12;border-radius:7px;overflow:hidden">
            <div style="background:#2a1a1a;padding:7px 13px;font-weight:700;color:#fca5a5;font-size:12px" id="tbl-b-hdr">ğŸ”« å¯¹æ‰‹</div>
            <table class="stbl" id="tbl-b"></table>
          </div>
        </div>
        <div style="margin-top:16px;text-align:center">
          <button class="btn" style="padding:10px 36px" id="next-map-btn" onclick="Match.exit()">ç»§ç»­ â”</button>
        </div>
      </div>
    </div>
  </div>

  <div id="pnl-awards" class="panel hidden">
    <div style="text-align:center;font-size:22px;font-weight:800;color:var(--gold);margin-bottom:6px">ğŸ† èµ›äº‹è½å¹•</div>
    <div id="awards-sub" style="text-align:center;margin-bottom:24px;line-height:2"></div>
    <div id="awards-mvp"></div>
    <div style="font-size:13px;font-weight:700;color:var(--dim);margin:22px 0 12px;border-bottom:1px solid var(--border);padding-bottom:8px">ğŸ– EVP æœ€ä½³äº”äºº</div>
    <div id="awards-evp"></div>
    <div style="margin-top:32px;text-align:center">
      <button class="btn" style="padding:11px 36px" onclick="Tour.closeAwards()">é¢†å–å¥–é‡‘å¹¶ç¦»å¼€ â”</button>
    </div>
  </div>
</div>

</div><!-- .main -->

<div id="bp-overlay" class="hidden">
  <div class="bp-title" id="bp-title">åœ°å›¾ Ban/Pick</div>
  <div class="bp-sub" id="bp-sub"></div>
  <div class="bp-phase" id="bp-phase">ç­‰å¾…å¼€å§‹</div>
  <div class="bp-legend">
    <span><span class="dot" style="background:var(--win)"></span>æˆ‘æ–¹å¼ºå›¾</span>
    <span><span class="dot" style="background:var(--loss)"></span>å¯¹æ–¹å¼ºå›¾</span>
    <span><span class="dot" style="background:var(--dim)"></span>ä¸­æ€§å›¾</span>
  </div>
  <div class="bp-status" id="bp-status"></div>
  <div class="bp-maps" id="bp-maps"></div>
</div>

<div id="career-modal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:900;display:flex;justify-content:center;align-items:center;padding:40px">
  <div class="panel" style="width:100%;max-width:600px;max-height:80vh;display:flex;flex-direction:column">
    <div style="display:flex;justify-content:space-between;margin-bottom:20px">
      <div id="career-name" style="font-size:20px;font-weight:700;color:var(--gold)"></div>
      <button class="btn dark" onclick="document.getElementById('career-modal').classList.add('hidden')">âœ• å…³é—­</button>
    </div>
    <div id="career-proto" class="hidden" style="margin-bottom:16px;padding:12px;background:rgba(255,215,0,0.08);border:1px solid rgba(255,215,0,0.3);border-radius:6px;font-size:12px;color:var(--dim2);line-height:1.5"></div>
    <div style="overflow-y:auto;flex:1">
      <table class="stbl">
        <thead><tr><th>å¹´ä»½</th><th>æˆ˜é˜Ÿ</th><th>Rating</th><th>MVPæ¬¡æ•°</th></tr></thead>
        <tbody id="career-table"></tbody>
      </table>
    </div>
  </div>
</div>

<div id="hltv-modal" class="hidden">
  <div style="color:var(--gold);font-size:36px;font-weight:900;margin-bottom:8px;letter-spacing:1px">HLTV TOP 20</div>
  <div id="hltv-year" style="color:var(--dim);margin-bottom:24px;font-size:14px;font-style:italic"></div>
  <div style="width:100%;max-width:760px" id="hltv-list"></div>
  <button class="btn" style="margin-top:24px;padding:12px 40px;font-size:15px" onclick="document.getElementById('hltv-modal').classList.add('hidden')">å…³é—­å¹¶å¼€å¯æ–°èµ›å­£</button>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CS LEGENDS v5.0 â€” æ ¸å¿ƒé€»è¾‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€ å¸¸é‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const NAME_COUNTRIES=[
  {code:'UA',country:'Ukraine',first:['Oleksandr','Denis','Ihor','Andrii'],last:['Kostyliev','Shevchenko','Bondarenko','Kravchenko']},
  {code:'DK',country:'Denmark',first:['Nicolai','Peter','Lukas','Andreas'],last:['Jensen','Hansen','Nielsen','Christensen']},
  {code:'SE',country:'Sweden',first:['Christopher','Patrik','Olof','Freddy'],last:['Lindberg','Alesund','Johansson','Larsson']},
  {code:'NO',country:'Norway',first:['Ola','Jon','Lars','Kristian'],last:['Moum','Hansen','Nilsen','Larsen']},
  {code:'FR',country:'France',first:['Kenny','Mathieu','Richard','Nathan'],last:['Schrub','Herbaut','Moreau','Dubois']},
  {code:'PL',country:'Poland',first:['JarosÅ‚aw','MichaÅ‚','PaweÅ‚','Filip'],last:['JarzÄ…bkowski','Nowak','Kowalski','WiÅ›niewski']},
  {code:'RU',country:'Russia',first:['Denis','Sergey','Ivan','Alexey'],last:['Sharipov','Kovalev','Petrov','Volkov']},
  {code:'US',country:'USA',first:['John','Jake','Ethan','Michael'],last:['Smith','Johnson','Brown','Davis']},
  {code:'BR',country:'Brazil',first:['Gabriel','Marcelo','Lucas','Yuri'],last:['Toledo','Silva','Oliveira','Souza']},
  {code:'FI',country:'Finland',first:['Aleksi','Jere','Jani','Sami'],last:['Virolainen','Laine','Virtanen','Korhonen']}
];
const HANDLE_CORES=['Sasha','ice','flame','shadow','storm','shift','nova','zero','flex','hunter','ghost','viper','aim','clutch'];
const HANDLE_SUFFIXES=['','-ic','-god','-shifter','-flex','-zero'];
const COACH_NAMES=["zonic","ave","kassad","threat","Aunkere","petr","lauNX","reatz","sdy","zehN","Robban","Snappi","MSL","stanislaw","adreN","lmbt","Xizt","SIXER","Trace","torben"];
const AI_TEAMS=["NAVI","FaZe","Vitality","G2","Spirit","MOUZ","VP","Astralis","NIP","fnatic","Liquid","Complexity","Cloud9","Heroic","ENCE","FURIA"];
const ROLES={
  Sniper:{zh:'ç‹™å‡»æ‰‹',color:'#ef4444'},
  Entry: {zh:'çªç ´æ‰‹',color:'#f59e0b'},
  Lurker:{zh:'è‡ªç”±äºº',color:'#8b5cf6'},
  IGL:   {zh:'æŒ‡æŒ¥',  color:'#06b6d4'},
  Rifler:{zh:'æ­¥æªæ‰‹',color:'#6b7280'}
};
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ä¸‰çº§ç‰¹è´¨åº“ (Trait Library v6)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// A. ã€å¸¸è§„ç‰¹è´¨ã€‘â€”â€” è·¯äººé€‰æ‰‹20%æ¦‚ç‡è·å¾—1ä¸ª
const NORMAL_TRAITS={
  headshot:{
    name:'çˆ†å¤´æœºå™¨', tier:'normal', color:'#ef4444', badge:'ğŸ¯',
    desc:'æ­¥æªå±€ï¼ˆFull Buyï¼‰å‡»æ€æƒé‡+15%ï¼›è§¦å‘å‡»æ€åœ¨æ—¥å¿—é«˜äº®',
    roundMult(buy){return buy.lvl==='Full'?0.03:0;},
    microWeightMult:1.25
  },
  bigHeart:{
    name:'å¤§å¿ƒè„', tier:'normal', color:'#f97316', badge:'ğŸ’ª',
    desc:'æ®‹å±€1vXæ—¶ClutchæˆåŠŸç‡+40%ï¼ŒæˆåŠŸå¿…å®šæ—¥å¿—é«˜äº®',
    clutchBonus:0.40
  },
  volatile:{
    name:'ç¥ç»åˆ€', tier:'normal', color:'#a855f7', badge:'âš¡',
    desc:'æ¯å›åˆæˆ˜åŠ›éšæœºä¹˜0.75~1.35ï¼Œæé«˜ä¸Šé™ä¸æä½ä¸‹é™',
    volatileMin:0.75, volatileMax:1.35
  },
  leader:{
    name:'é¢†è¢–', tier:'normal', color:'#eab308', badge:'ğŸ“£',
    desc:'æ‹…ä»»IGLæ—¶å…¨é˜Ÿå›åˆæˆ˜åŠ›+4%ï¼›é¦–æ¬¡è§¦å‘æ—¥å¿—æ’­æŠ¥',
    roundMult(role){return role==='IGL'?0.04:0;}
  }
};

// B. ã€é€šç”¨ä¼ å¥‡ç‰¹è´¨ã€‘â€”â€” ä»… Regen Legend (0.5%) å¯æŠ½å–
const GENERIC_LEGEND_TRAITS={
  legend_core:{
    name:'ç»å¯¹æ ¸å¿ƒ', tier:'legend_generic', color:'#ffd700', badge:'ğŸ’',
    desc:'1vXæ®‹å±€æ—¶ä¸ªäººæˆ˜åŠ›+20%ï¼Œå¼ºåˆ¶å°è¯•Clutchï¼›é‡‘å­—é«˜äº®æ’­æŠ¥',
    clutchPowerBonus:0.20
  },
  legend_winner:{
    name:'å¤©ç”Ÿèµ¢å®¶', tier:'legend_generic', color:'#ffd700', badge:'ğŸ†',
    desc:'åŠå†³èµ›/å†³èµ›é˜¶æ®µï¼Œèµ›åRatingå¼ºåˆ¶â‰¥1.10ï¼›è§¦å‘æ—¶é‡‘å­—é«˜äº®æ’­æŠ¥',
    minRatingInFinals:1.10
  }
};

// C. ã€å†å²ä¸“å±ç­¾åç‰¹è´¨ã€‘â€”â€” å”¯ä¸€ç»‘å®šç‰¹å®šçœŸå®é€‰æ‰‹
const SIGNATURE_TRAITS={
  sig_s1mple:{
    name:'å¤©å¤–é£ä»™', tier:'signature', color:'#ff6b35', badge:'ğŸ‘‘',
    owner:'s1mple', ownerDisplay:'s1mple',
    desc:'ã€s1mpleä¸“å±ã€‘è½åâ‰¥4åˆ†æ—¶è‡ªåŠ¨æ¥ç®¡ï¼šæˆ˜åŠ›+20%ï¼Œå¤šæ€æ¦‚ç‡ç¿»å€ï¼›é¦–æ¬¡è§¦å‘é‡‘å­—æ’­æŠ¥',
    powerBonus:0.20, multiKillMult:2.0, gapTrigger:4
  },
  sig_zywoo:{
    name:'è½½ç‰©é¢†åŸŸ', tier:'signature', color:'#00d4ff', badge:'ğŸŒ€',
    owner:'ZyWoO', ownerDisplay:'ZyWoO',
    desc:'ã€ZyWoOä¸“å±ã€‘å…ç–«è´Ÿé¢çŠ¶æ€ï¼›æ‰‹æªå±€æˆ˜åŠ›ä¸æ‰“æŠ˜æ‰£ï¼›1vXæ®‹å±€Clutch+55%',
    immuneNegative:true, pistolFullPower:true, clutchBonus:0.55
  },
  sig_karrigan:{
    name:'æˆ˜æœ¯å¤§è„‘', tier:'signature', color:'#a78bfa', badge:'ğŸ§ ',
    owner:'karrigan', ownerDisplay:'karrigan',
    desc:'ã€karriganä¸“å±ã€‘ä¸Šåœºæ—¶æ— è§†Synergyæƒ©ç½šï¼ˆå¼ºåˆ¶â‰¥1.0ï¼‰ï¼Œå…¨é˜Ÿæˆ˜åŠ›Ã—1.1',
    ignoreSynergyPenalty:true, teamPowerMult:1.1
  },
  sig_gla1ve:{
    name:'æˆ˜æœ¯å¤§è„‘', tier:'signature', color:'#a78bfa', badge:'ğŸ§ ',
    owner:'gla1ve', ownerDisplay:'gla1ve',
    desc:'ã€gla1veä¸“å±ã€‘ä¸Šåœºæ—¶æ— è§†Synergyæƒ©ç½šï¼ˆå¼ºåˆ¶â‰¥1.0ï¼‰ï¼Œå…¨é˜Ÿæˆ˜åŠ›Ã—1.1',
    ignoreSynergyPenalty:true, teamPowerMult:1.1
  },
  sig_f0rest:{
    name:'ä¸è€ç¥è¯', tier:'signature', color:'#34d399', badge:'ğŸŒ²',
    owner:'f0rest', ownerDisplay:'f0rest',
    desc:'ã€f0restä¸“å±ã€‘30å²åèƒ½åŠ›å€¼æ°¸ä¹…ä¸å—å¹´é¾„å½±å“ï¼Œæ‹’ç»ä¸‹æ»‘',
    agelessAfter:30
  }
};

// ç»Ÿä¸€æŸ¥è¯¢æ¥å£ï¼ˆå‘åå…¼å®¹ TRAITS / LEGEND_TRAITS å¼•ç”¨ï¼‰
const ALL_TRAITS={...NORMAL_TRAITS,...GENERIC_LEGEND_TRAITS,...SIGNATURE_TRAITS};
const TRAITS=ALL_TRAITS;
const LEGEND_TRAITS=ALL_TRAITS;

// å¸¸é‡é”®åˆ—è¡¨
const NORMAL_TRAIT_KEYS=Object.keys(NORMAL_TRAITS);       // ['headshot','bigHeart','volatile','leader']
const GENERIC_LEGEND_KEYS=Object.keys(GENERIC_LEGEND_TRAITS); // ['legend_core','legend_winner']

// ç‰¹è´¨å±‚çº§åˆ¤æ–­
const traitTier=k=>{if(SIGNATURE_TRAITS[k])return'signature';if(GENERIC_LEGEND_TRAITS[k])return'legend_generic';return'normal';};
const isSignatureTrait=k=>!!SIGNATURE_TRAITS[k];
const isAnyLegendTrait=k=>!!GENERIC_LEGEND_TRAITS[k]||!!SIGNATURE_TRAITS[k];

// ç‰¹è´¨å¾½ç« æ¸²æŸ“ï¼ˆåˆ†çº§é…è‰²+åŠ¨ç”»ï¼‰
const renderTraitBadge=(key,withTooltip=true)=>{
  const T=ALL_TRAITS[key];if(!T)return'';
  const tier=T.tier||'normal';
  let cls,style;
  if(tier==='signature'){
    cls='trait-sig';
    style=`background:linear-gradient(135deg,${T.color}33,${T.color}66);border:1px solid ${T.color};color:${T.color};`;
  }else if(tier==='legend_generic'){
    cls='trait-legend';
    style=`background:rgba(255,215,0,0.15);border:1px solid #ffd700;color:#ffd700;`;
  }else{
    cls='trait-normal';
    style=`background:${T.color}22;border:1px solid ${T.color}66;color:${T.color};`;
  }
  const tip=withTooltip?` title="${T.name}ï¼š${T.desc}"`:'';
  return`<span class="${cls}" style="${style}"${tip}>${T.badge||''} ${T.name}</span>`;
};
const RARITY={
  common:  {name:'æ™®é€š',color:'#fff',   border:'1px solid var(--border)'},
  uncommon:{name:'ä¼˜ç§€',color:'#86efac',border:'1px solid #86efac'},
  rare:    {name:'æ˜æ˜Ÿ',color:'#a855f7',border:'1px solid #a855f7'},
  legend:  {name:'ä¼ å¥‡',color:'#ffd700',border:'2px solid #ffd700',shadow:'0 0 10px rgba(255,215,0,0.3)'}
};
const ERA_MAPS={
  2000:['Dust2','Inferno','Nuke','Train','Tuscan','Mirage_16','Aztec'],
  2012:['Dust2','Inferno','Nuke','Train','Mirage','Overpass','Cache'],
  2017:['Dust2','Inferno','Nuke','Train','Mirage','Overpass','Cobblestone'],
  2019:['Dust2','Inferno','Nuke','Train','Mirage','Overpass','Vertigo'],
  2021:['Dust2','Inferno','Nuke','Ancient','Mirage','Overpass','Vertigo'],
  2023:['Dust2','Inferno','Nuke','Ancient','Mirage','Anubis','Vertigo']
};
const MAP_DISPLAY={Mirage_16:'Mirage',Dust2:'Dust2',Inferno:'Inferno',Nuke:'Nuke',Train:'Train',Tuscan:'Tuscan',Aztec:'Aztec',Mirage:'Mirage',Overpass:'Overpass',Cache:'Cache',Cobblestone:'Cobble.',Vertigo:'Vertigo',Ancient:'Ancient',Anubis:'Anubis'};
const HISTORICAL_DATA={
  era2000:{
    teams:[
      {name:'NiP',      rating:90,players:['HeatoN','Potti']},
      {name:'SK Gaming',rating:88,players:['SpawN']},
      {name:'Team 3D',  rating:86,players:['Ksharp']},
      {name:'mTw',      rating:85,players:['elemeNt']}
    ],
    players:{
      HeatoN: {name:'HeatoN', role:'Entry', rating:92,age:20,country:'Sweden',countryCode:'SE',realName:'Emil Christensen',
                normalTraits:['headshot','bigHeart']},
      Potti:  {name:'Potti',  role:'Rifler',rating:90,age:21,country:'Sweden',countryCode:'SE',realName:'Tommy Ingemarsson',
                normalTraits:['headshot','volatile']},
      SpawN:  {name:'SpawN',  role:'Rifler',rating:89,age:19,country:'Sweden',countryCode:'SE',realName:'Abdisamad Mohamed',
                normalTraits:['bigHeart','headshot']},
      elemeNt:{name:'elemeNt',role:'IGL',   rating:88,age:20,country:'Norway',countryCode:'NO',realName:'Ola Moum',
                normalTraits:['leader','bigHeart']},
      Ksharp: {name:'Ksharp', role:'Sniper',rating:87,age:22,country:'USA',   countryCode:'US',realName:'Kyle Miller',
                normalTraits:['headshot','volatile']}
    }
  },
  era2012:{
    teams:[
      {name:'Virtus.pro',rating:88,players:['pashaBiceps']},
      {name:'Fnatic',    rating:90,players:['JW']},
      {name:'Titan',     rating:89,players:['KennyS']},
      {name:'LDLC',      rating:87,players:[]},
      {name:'NiP',       rating:93,players:['GeT_RiGhT','f0rest']}
    ],
    players:{
      GeT_RiGhT:  {name:'GeT_RiGhT',  role:'Lurker',rating:95,age:22,country:'Sweden',countryCode:'SE',realName:'Christopher Alesund',
                    normalTraits:['bigHeart','headshot']},
      f0rest:     {name:'f0rest',      role:'Rifler',rating:93,age:24,country:'Sweden',countryCode:'SE',realName:'Patrik Lindberg',
                    signatureTrait:'sig_f0rest', normalTraits:['headshot','bigHeart']},
      JW:         {name:'JW',          role:'Sniper',rating:90,age:20,country:'Sweden',countryCode:'SE',realName:'Jesper Wecksell',
                    normalTraits:['volatile','headshot']},
      KennyS:     {name:'KennyS',      role:'Sniper',rating:94,age:18,country:'France',countryCode:'FR',realName:'Kenny Schrub',
                    normalTraits:['headshot','bigHeart']},
      pashaBiceps:{name:'pashaBiceps', role:'Rifler',rating:90,age:24,country:'Poland',countryCode:'PL',realName:'JarosÅ‚aw JarzÄ…bkowski',
                    normalTraits:['bigHeart','volatile']}
    }
  },
  era2020:{
    teams:[
      {name:'NAVI',    rating:95,players:['s1mple']},
      {name:'Vitality',rating:94,players:['ZywOo']},
      {name:'G2',      rating:92,players:['NiKo']},
      {name:'Astralis',rating:90,players:['dev1ce']}
    ],
    players:{
      s1mple:{name:'s1mple',role:'Sniper',rating:97,age:23,country:'Ukraine',countryCode:'UA',realName:'Oleksandr Kostyliev',
               debutYear:2014,debutAge:16,firstTeamId:'NAVI',
               signatureTrait:'sig_s1mple', normalTraits:['bigHeart','headshot']},
      ZywOo: {name:'ZyWoO', role:'Sniper',rating:96,age:20,country:'France', countryCode:'FR',realName:'Mathieu Herbaut',
               debutYear:2018,debutAge:17,firstTeamId:'Vitality',
               signatureTrait:'sig_zywoo',  normalTraits:['headshot','bigHeart']},
      NiKo:  {name:'NiKo',  role:'Rifler',rating:94,age:23,country:'Bosnia & Herzegovina',countryCode:'BA',realName:'Nikola KovaÄ',
               debutYear:2013,debutAge:16,firstTeamId:'G2',
               normalTraits:['headshot','volatile']},
      dev1ce:{name:'dev1ce',role:'Sniper',rating:93,age:24,country:'Denmark',countryCode:'DK',realName:'Nicolai Reedtz',
               debutYear:2012,debutAge:17,firstTeamId:'Astralis',
               normalTraits:['bigHeart','headshot']},
      donk:  {name:'donk',  role:'Rifler',rating:95,age:19,country:'Russia', countryCode:'RU',realName:'Danil Kryshkovets',
               debutYear:2023,debutAge:16,firstTeamId:'Spirit',
               normalTraits:['volatile','headshot']}
    }
  }
};
const REAL_TEAM_IDS=(()=>{
  const s=new Set();
  Object.values(HISTORICAL_DATA).forEach(e=>{if(e&&e.teams)e.teams.forEach(t=>s.add(t.name));});
  ['NAVI','FaZe','Vitality','G2','NIP','fnatic','Astralis','Virtus.pro','Fnatic','Spirit'].forEach(n=>s.add(n));
  return s;
})();
const isRealTeam=n=>n&&REAL_TEAM_IDS.has(n);
const teamNameWithStar=n=>n?(isRealTeam(n)?n+' <span style="color:#ffd700" title="çœŸå®æˆ˜é˜Ÿ">â­</span>':n):'';
const RANDOM_EVENTS=[
  {txt:'${p} å‚åŠ äº†ç½‘ç»œç›´æ’­ï¼Œç¡çœ ä¸è¶³ã€‚',      effect:p=>{p.form=Math.max(.7,p.form-.06)},target:'player'},
  {txt:'${p} åœ¨ä¸ªäººç›´æ’­ä¸­çŠ¶æ€æä½³ï¼Œæ‰‹æ„Ÿç«çƒ­ï¼', effect:p=>{p.form=Math.min(1.2,p.form+.06)},target:'player'},
  {txt:'${p} å› è½»ä¼¤ä¼‘æ¯äº†å‡ å¤©ã€‚',               effect:p=>{p.form=Math.max(.75,p.form-.05)},target:'player'},
  {txt:'ä¿±ä¹éƒ¨æ”¶åˆ°èµåŠ©å•†é¼“åŠ±ï¼Œå…¨é˜Ÿå£«æ°”ææŒ¯ï¼',  effect:null,target:'team',teamEffect:r=>{r.forEach(p=>p.form=Math.min(1.15,p.form+.04))}},
  {txt:'å¤‡æˆ˜æœŸé—´è®­ç»ƒè®¾æ–½æ•…éšœï¼Œå½±å“æœ¬å‘¨è®­ç»ƒã€‚',  effect:null,target:'team',teamEffect:r=>{r.forEach(p=>p.form=Math.max(.8,p.form-.04))}},
  {txt:'${p} å‚åŠ äº†æ…ˆå–„èµ›äº‹ï¼Œç»éªŒä¸°å¯Œå¿ƒæ€ç¨³å®šã€‚',effect:p=>{p.form=Math.min(1.18,p.form+.04)},target:'player'},
  {txt:'è¿‘æœŸè”é˜Ÿåˆä½œé¢‘ç¹ï¼Œç£¨åˆåº¦å¾®å‡ã€‚',         effect:null,target:'chem',chemEffect:3},
  {txt:'å†…éƒ¨æ„è§åˆ†æ­§ï¼Œç£¨åˆåº¦ç•¥æœ‰ä¸‹é™ã€‚',         effect:null,target:'chem',chemEffect:-4},
  {txt:'${p} æ‰‹è…•æœ‰äº›ä¸é€‚ï¼ŒçŠ¶æ€å—è½»å¾®å½±å“ã€‚',   effect:p=>{p.form=Math.max(.78,p.form-.05)},target:'player'},
  {txt:'${p} æœ€è¿‘ç§ä¸‹è‹¦ç»ƒï¼ŒçŠ¶æ€æ‚„æ‚„ä¸Šæ¶¨ã€‚',      effect:p=>{p.form=Math.min(1.2,p.form+.05)},target:'player'},
];

const rnd =(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const pick=arr=>arr[Math.floor(Math.random()*arr.length)];
const fmtD=d=>d.toISOString().split('T')[0];

// â”€â”€â”€ MapUtils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MapUtils={
  poolForYear(y){
    const keys=Object.keys(ERA_MAPS).map(Number).sort((a,b)=>a-b);
    let pool=ERA_MAPS[2000];
    for(const k of keys){if(y>=k)pool=ERA_MAPS[k];}
    return pool;
  },
  display(m){return MAP_DISPLAY[m]||m;},
  genPlayerMaps(birthYear){
    const pool=this.poolForYear(birthYear||2000);
    const n=rnd(2,3);
    return [...pool].sort(()=>Math.random()-.5).slice(0,n).map(m=>({map:m,str:rnd(65,95)}));
  },
  teamMapStr(roster,coach,map){
    let score=50;
    (roster||[]).forEach(p=>{const m=(p.maps||[]).find(x=>x.map===map);if(m)score+=m.str*.25;});
    if(coach){const cm=(coach.maps||[]).find(x=>x.map===map);if(cm)score+=cm.str*.4;}
    return Math.min(99,score);
  },
  teamPoolRatings(roster,coach,year){
    return this.poolForYear(year).map(m=>({map:m,str:this.teamMapStr(roster,coach,m)}));
  }
};

// â”€â”€â”€ World â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const World={
  players:[],teams:[],
  genRandomIdentity(){
    const cfg=pick(NAME_COUNTRIES);
    const core=pick(HANDLE_CORES),suf=pick(HANDLE_SUFFIXES),handle=core+(suf||'');
    return{first:pick(cfg.first),last:pick(cfg.last),handle,name:`${pick(cfg.first)} "${handle}" ${pick(cfg.last)}`,country:cfg.country,countryCode:cfg.code};
  },
  mkRealPlayer(cfg,teamName){
    const rating=cfg.rating,age=cfg.age||20;
    const pot=cfg.potential!=null?cfg.potential:Math.min(99,rating+5);
    const rarity=cfg.rarity||(rating>=90?'legend':rating>=80?'rare':'uncommon');
    const handle=cfg.handle||cfg.name;
    const realName=cfg.realName||null;

    // â”€â”€ ç‰¹è´¨ç»„è£…ï¼šç­¾åç‰¹è´¨ï¼ˆå”¯ä¸€ï¼‰+ HISTORICAL_DATA é¢„è®¾å¸¸è§„ç‰¹è´¨
    const myTraits=[];
    // C. ç­¾åç‰¹è´¨ï¼ˆä¼˜å…ˆï¼Œå”¯ä¸€æ€§ä¿è¯ï¼‰
    if(cfg.signatureTrait&&SIGNATURE_TRAITS[cfg.signatureTrait]){
      myTraits.push(cfg.signatureTrait);
    }
    // A. HISTORICAL_DATA é…ç½®çš„ normalTraitsï¼ˆæœ€å¤š2ä¸ªï¼Œå»é‡ï¼‰
    const presetNormals=cfg.normalTraits||[];
    for(const t of presetNormals){
      if(NORMAL_TRAITS[t]&&!myTraits.includes(t))myTraits.push(t);
      if(myTraits.filter(x=>NORMAL_TRAITS[x]).length>=2)break;
    }
    // è‹¥ normalTraits ä¸è¶³2ä¸ªï¼ŒæŒ‰è§’è‰²è¡¥è¶³
    if(myTraits.filter(x=>NORMAL_TRAITS[x]).length<2){
      const roleDefault={Sniper:'headshot',Rifler:'headshot',Entry:'bigHeart',Lurker:'bigHeart',IGL:'leader'};
      const fallback=roleDefault[cfg.role]||'headshot';
      if(!myTraits.includes(fallback))myTraits.push(fallback);
      if(myTraits.filter(x=>NORMAL_TRAITS[x]).length<2){
        const extra=NORMAL_TRAIT_KEYS.find(k=>!myTraits.includes(k))||'volatile';
        myTraits.push(extra);
      }
    }

    return{
      id:'real_'+cfg.name+'_'+rnd(1000,9999),
      name:handle+(realName?` (${realName})`:''),
      role:cfg.role,rating,potential:pot,age,form:1.0,
      price:rating*40+(rating+(pot-rating))*20,
      salary:Math.floor(rating*rating/10),
      teamId:teamName||null,rarity,
      traits:[...new Set(myTraits)],
      maps:MapUtils.genPlayerMaps(2000-(age-17)),
      ys:{matches:0,ratingSum:0,mvps:0,majorWins:0,wins:0},
      history:[],_ageDecayYear:null,isReal:true,
      country:cfg.country||'Unknown',countryCode:cfg.countryCode||null,
      handle,realName
    };
  },
  init(startYear){
    this.players=[];this.teams=[];
    const y=startYear||2000;
    const eraKey=y>=2020?'era2020':(y>=2012?'era2012':'era2000');
    const eraData=HISTORICAL_DATA[eraKey];
    const usedTeams=new Set();
    if(eraData){
      eraData.teams.forEach(t=>{
        const base=t.rating,roster=[];
        (t.players||[]).forEach(pKey=>{
          const cfg=eraData.players[pKey];if(!cfg)return;
          const p=this.mkRealPlayer(cfg,t.name);
          this.players.push(p);roster.push(p);
        });
        while(roster.length<5){const p=this.mkP(base-8,base+12,true,null,y);p.teamId=t.name;this.players.push(p);roster.push(p);}
        const coach=this.mkCoach(true);
        this.teams.push({id:t.name,name:t.name,rating:base,roster,coach,isPlayer:false});
        usedTeams.add(t.name);
      });
    }
    const aiPool=AI_TEAMS.filter(n=>!usedTeams.has(n));
    let idx=0;
    while(this.teams.length<16&&idx<aiPool.length){
      const name=aiPool[idx++];
      const base=65+rnd(0,25),roster=[];
      ['IGL','Sniper','Entry','Lurker','Rifler'].forEach(role=>{
        const p=this.mkP(base-8,base+12,true,role,y);p.teamId=name;this.players.push(p);roster.push(p);
      });
      const coach=this.mkCoach(true);
      this.teams.push({id:name,name,rating:base,roster,coach,isPlayer:false});
    }
  },
  mkP(min,max,ai=false,forceRole=null,birthYear=2000){
    // Regen Legend ä»…åœ¨éAIè·¯äººé€‰æ‰‹ä¸­è§¦å‘ï¼ˆ0.5%ï¼‰
    const isRegenLegend=!ai&&Math.random()<0.005;
    let rating,pot,age;
    if(isRegenLegend){rating=rnd(90,99);age=rnd(18,22);pot=99;}
    else{rating=rnd(min,max);age=rnd(16,30);pot=Math.min(99,rating+(age<=20?rnd(10,25):age<=25?rnd(5,12):rnd(0,3)));}
    let rarity='common';
    if(isRegenLegend)rarity='legend';
    else if(rating>=85)rarity='rare';
    else if(rating>=75)rarity='uncommon';

    // â”€â”€ ç‰¹è´¨åˆ†é…ï¼ˆä¸‰çº§ï¼‰
    const myTraits=[];
    if(ai){
      // AI é˜Ÿå‘˜æ— ç‰¹è´¨ï¼ˆç®€åŒ–é€»è¾‘ï¼ŒAIé˜Ÿä¼ä¸éœ€è¦ç‰¹è´¨åŠ æˆï¼‰
    }else if(isRegenLegend){
      // B. é€šç”¨ä¼ å¥‡ç‰¹è´¨ï¼š1ä¸ªä¼ å¥‡ + 2ä¸ªå¸¸è§„ï¼ˆå»é‡ï¼‰
      myTraits.push(pick(GENERIC_LEGEND_KEYS));
      const pool=NORMAL_TRAIT_KEYS.filter(k=>!myTraits.includes(k));
      myTraits.push(pick(pool));
      const pool2=NORMAL_TRAIT_KEYS.filter(k=>!myTraits.includes(k));
      if(pool2.length)myTraits.push(pick(pool2));
    }else if(Math.random()<0.20){
      // A. æ™®é€šè·¯äººï¼š20%æ¦‚ç‡è·å¾—1ä¸ªå¸¸è§„ç‰¹è´¨
      myTraits.push(pick(NORMAL_TRAIT_KEYS));
    }

    const ident=this.genRandomIdentity();
    const obj={
      id:(ai?'ai_':'p_')+rnd(10000,99999),
      name:ident.name,role:forceRole||pick(Object.keys(ROLES)),
      rating,potential:pot,age,form:1.0,
      price:rating*40+(rating+(pot-rating))*20+rnd(0,500),
      salary:Math.floor(rating*rating/10)*(isRegenLegend?2:1),
      teamId:null,rarity,traits:[...new Set(myTraits)],
      maps:MapUtils.genPlayerMaps(birthYear),
      ys:{matches:0,ratingSum:0,mvps:0,majorWins:0,wins:0},
      history:[],_ageDecayYear:null,
      country:ident.country,countryCode:ident.countryCode,handle:ident.handle,
      isRegenLegend // æ ‡è®°ï¼Œç”¨äºUIé‡‘è‰²è¾¹æ¡†
    };
    return obj;
  },
  mkCoach(ai=false){
    const tactics=rnd(ai?50:45,ai?85:80),yr=rnd(1995,2010);
    return{
      id:(ai?'ac_':'c_')+rnd(10000,99999),
      name:pick(COACH_NAMES)+(ai?'':'-'+rnd(1,9)),
      tactics,age:rnd(28,50),maps:MapUtils.genPlayerMaps(yr),
      price:tactics*30+rnd(0,300),
      salary:Math.floor(tactics*tactics/10),
      teamId:null,isAI:ai
    };
  }
};

// â”€â”€â”€ Market â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Market={
  pList:[],cList:[],currentTab:'players',
  refresh(free=false){
    if(!free&&Game.money<500)return UI.toast('èµ„é‡‘ä¸è¶³ï¼åˆ·æ–°éœ€è¦ $500');
    if(!free)Game.money-=500;
    this.pList=[];this.cList=[];
    const q=55+Math.floor(Math.min(Game.fans,5000)/100);
    for(let i=0;i<6;i++){const p=World.mkP(q-5,q+15);World.players.push(p);this.pList.push(p);}
    for(let i=0;i<3;i++){const c=World.mkCoach();this.cList.push(c);}
    this.renderAll();if(!free)UI.refresh();
  },
  showTab(t){
    this.currentTab=t;
    document.getElementById('tab-players').classList.toggle('on',t==='players');
    document.getElementById('tab-coaches').classList.toggle('on',t==='coaches');
    document.getElementById('market-players').classList.toggle('hidden',t!=='players');
    document.getElementById('market-coaches').classList.toggle('hidden',t!=='coaches');
  },
  renderAll(){this.renderPlayers();this.renderCoaches();},
  renderPlayers(){
    const yr=Game.date.getFullYear();
    const el=document.getElementById('market-players');if(!el)return;
    el.innerHTML=this.pList.map(p=>{
      const pool=MapUtils.poolForYear(yr);
      const myMaps=(p.maps||[]).filter(m=>pool.includes(m.map));
      const traitBadges=(p.traits||[]).map(t=>renderTraitBadge(t)).join('');
      const rar=RARITY[p.rarity||'common'];
      const legendClass=p.isRegenLegend?'regen-legend':'';
      const nameStyle=p.rarity==='legend'||p.isRegenLegend?'color:#ffd700;font-weight:700':'';
      return`<div class="card ${legendClass}" onclick="UI.showPlayer('${p.id}')" style="cursor:pointer;border:${rar.border};${rar.shadow?`box-shadow:${rar.shadow}`:''}">
        <span class="rbadge" style="background:${ROLES[p.role].color}">${ROLES[p.role].zh}</span>
        <div class="cname" style="${nameStyle}">${p.name} <span style="font-size:10px;color:var(--dim)">(${p.age}å²)</span></div>
        <div style="margin:4px 0 6px;min-height:18px">${traitBadges}</div>
        <div class="cstat"><span>èƒ½åŠ›å€¼</span><b>${p.rating}</b></div>
        <div class="cstat"><span>æ½œåŠ›</span><b style="color:${p.potential>=85?'var(--gold)':p.potential>=75?'var(--win)':'var(--dim)'}">${p.potential}</b></div>
        <div class="cstat"><span>ä¹°æ–­è´¹</span><b style="color:#86efac">$${p.price.toLocaleString()}</b></div>
        <div class="mapbars">${myMaps.slice(0,2).map(m=>`<div class="mapbar-row"><span class="mapbar-name">${MapUtils.display(m.map)}</span><div class="mapbar-bg"><div class="mapbar-fill" style="width:${m.str}%;background:var(--win)"></div></div><span style="font-size:10px;color:var(--dim)">${m.str}</span></div>`).join('')}</div>
        <button class="btn full" onclick="event.stopPropagation();Game.buyP('${p.id}')">ç­¾çº¦é€‰æ‰‹</button>
      </div>`;
    }).join('');
  },
  renderCoaches(){
    const el=document.getElementById('market-coaches');if(!el)return;
    el.innerHTML=this.cList.map(c=>`
      <div class="card coach-card">
        <span class="rbadge" style="background:var(--blue)">æ•™ç»ƒ</span>
        <div class="cname">${c.name} <span style="font-size:10px;color:var(--dim)">(${c.age}å²)</span></div>
        <div class="cstat"><span>æˆ˜æœ¯æ°´å¹³</span><b style="color:var(--blue)">${c.tactics}</b></div>
        <div class="cstat"><span>BPç²¾å‡†åº¦</span><b>${Math.round(40+c.tactics*.5)}%</b></div>
        <div class="cstat"><span>ç­¾çº¦è´¹</span><b style="color:#86efac">$${c.price.toLocaleString()}</b></div>
        <div class="mapbars">${(c.maps||[]).slice(0,2).map(m=>`<div class="mapbar-row"><span class="mapbar-name">${MapUtils.display(m.map)}</span><div class="mapbar-bg"><div class="mapbar-fill" style="width:${m.str}%;background:var(--blue)"></div></div><span style="font-size:10px;color:var(--dim)">${m.str}</span></div>`).join('')}</div>
        <button class="btn full" onclick="Game.buyC('${c.id}')">ç­¾çº¦æ•™ç»ƒ</button>
      </div>`).join('');
  }
};

// â”€â”€â”€ SaveManager â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SaveManager={
  key:'cs_legends_save_v6',
  save(){
    try{
      const data={date:Game.date.toISOString(),money:Game.money,fans:Game.fans,roster:Game.roster,coach:Game.coach,trophies:Game.trophies||[],news:Game.news||[],bankruptcyDays:Game.bankruptcyDays||0};
      localStorage.setItem(this.key,JSON.stringify(data));
      UI.toast('ğŸ’¾ æ¸¸æˆå·²ä¿å­˜');
    }catch(e){console.error(e);UI.toast('âŒ ä¿å­˜å¤±è´¥');}
  },
  load(){
    const json=localStorage.getItem(this.key);if(!json)return false;
    try{
      const data=JSON.parse(json);
      Game.date=new Date(data.date);Game.money=data.money;Game.fans=data.fans;
      Game.trophies=data.trophies||[];Game.news=data.news||[];
      Game.bankruptcyDays=data.bankruptcyDays||0;
      Game.roster=data.roster||[];
      Game.roster.forEach(p=>{
        if(!World.players.find(x=>x.id===p.id))World.players.push(p);
        if(p.salary===undefined)p.salary=Math.floor(p.rating*p.rating/10);
        if(!p.traits)p.traits=[];if(!p.maps)p.maps=[];if(!p.ys)p.ys={matches:0,ratingSum:0,mvps:0,majorWins:0,wins:0};
      });
      Game.coach=data.coach||null;
      if(Game.coach&&Game.coach.salary===undefined)Game.coach.salary=Math.floor(Game.coach.tactics*Game.coach.tactics/10);
      UI.toast('ğŸ“‚ å­˜æ¡£å·²è¯»å–');return true;
    }catch(e){console.error(e);UI.toast('âŒ å­˜æ¡£æŸå');return false;}
  },
  hasSave(){return!!localStorage.getItem(this.key);}
};

// â”€â”€â”€ Game â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Game={
  date:new Date('2000-01-01'),money:5000,fans:100,
  roster:[],coach:null,trophies:[],news:[],
  chem:50,fatigue:0,training:'rest',
  bankruptcyDays:0,synCache:{mult:1,msgs:[]},
  eras:[
    {name:'CS 1.6 Era', winR:16,halfR:15,lossReset:true},
    {name:'CS:GO Era',  winR:16,halfR:15,lossReset:false},
    {name:'CS2 Era',    winR:13,halfR:12,lossReset:false}
  ],
  get era(){const y=this.date.getFullYear();return y>=2023?2:y>=2012?1:0;},
  get eraObj(){return this.eras[this.era];},
  get weeklySalary(){
    const rs=this.roster.reduce((a,b)=>a+(b.salary||Math.floor(b.rating*b.rating/10)),0);
    const cs=this.coach?(this.coach.salary||Math.floor(this.coach.tactics*this.coach.tactics/10)):0;
    return rs+cs;
  },
  pushNews(msg){
    this.news.unshift({date:fmtD(this.date),msg});
    if(this.news.length>20)this.news.pop();
    const el=document.getElementById('news-ticker');
    if(el)el.innerHTML=this.news.map(n=>`<div style="margin-bottom:4px;border-bottom:1px dashed var(--border);padding-bottom:2px"><span style="color:var(--dim)">${n.date}</span><br><span style="color:#eee">${n.msg}</span></div>`).join('');
  },
  init(){
    // å…ˆè®¾ç½®æ—¥æœŸï¼Œå†åˆå§‹åŒ–ä¸–ç•Œï¼ˆæ—¶ä»£åˆ¤æ–­ä¾èµ–æ—¥æœŸï¼‰
    this.date=new Date('2000-01-01');
    World.init(2000);
    if(SaveManager.hasSave()&&SaveManager.load()){
      Cal.genYear(this.date.getFullYear());
      if(this.news&&this.news.length){
        const el=document.getElementById('news-ticker');
        if(el)el.innerHTML=this.news.map(n=>`<div style="margin-bottom:4px;border-bottom:1px dashed var(--border);padding-bottom:2px"><span style="color:var(--dim)">${n.date}</span><br><span style="color:#eee">${n.msg}</span></div>`).join('');
      }
    }else{
      ['IGL','Sniper','Entry','Rifler','Lurker'].forEach(role=>{
        const p=World.mkP(55,65,false,role,2000);p.teamId='PLAYER';World.players.push(p);this.roster.push(p);
      });
      Cal.genYear(2000);this.money+=500;this.pushNews('ä¿±ä¹éƒ¨æˆç«‹ï¼Œå¼€å¯å¾ç¨‹ï¼');
    }
    // å…è´¹åˆå§‹åŒ–å¸‚åœºï¼ˆä¸æ‰£é’±ï¼‰
    Market.refresh(true);
    UI.refresh();
  },
  advanceDay(){
    this.date.setDate(this.date.getDate()+1);
    const y=this.date.getFullYear(),mo=this.date.getMonth(),d=this.date.getDate();
    // å†å²å¤©æ‰å°‘å¹´ç™»åœº
    this._checkDebuts(y);
    // å‘¨è–ª
    if(this.date.getDay()===1){
      const ws=this.weeklySalary;this.money-=ws;
      UI.toast(`ğŸ’¸ æ”¯ä»˜å‘¨è–ª $${ws.toLocaleString()}`);
      if(this.money<0){
        this.bankruptcyDays+=7;
        if(this.bankruptcyDays>=7){
          const sorted=[...this.roster].sort((a,b)=>(b.salary||0)-(a.salary||0));
          if(sorted.length>0){const target=sorted[0];this.fireP(target.id);this.pushNews(`ğŸ’” èµ„é‡‘é“¾æ–­è£‚ï¼æˆ˜é˜Ÿè¢«è¿«è§£çº¦ ${target.name}`);}
          this.bankruptcyDays=0;
        }else{UI.toast('âš  èµ„é‡‘ä¸è¶³ï¼è¯·åœ¨ä¸€å‘¨å†…æ‰­äºä¸ºç›ˆï¼');}
      }else{this.bankruptcyDays=0;}
    }
    // è®­ç»ƒ
    if(this.training==='rest'){
      this.fatigue=Math.max(0,this.fatigue-5);
      this.roster.forEach(p=>p.form=Math.min(1.2,p.form+.02));
    }else if(this.training==='aim'){
      const coachBonus=this.coach?this.coach.tactics/500:0;
      const hasIron=this.roster.some(p=>(p.traits||[]).includes('iron'));
      if(!hasIron)this.fatigue+=2;
      this.roster.forEach(p=>{if(p.rating<p.potential&&Math.random()<.15+coachBonus)p.rating++;});
    }else{
      const hasIron=this.roster.some(p=>(p.traits||[]).includes('iron'));
      if(!hasIron)this.fatigue+=2;
      const cap=this.chemCap(),mult=this.coach?1+this.coach.tactics/200:1;
      this.chem=Math.min(cap,this.chem+mult);
    }
    if(this.fatigue>80)this.roster.forEach(p=>p.form=Math.max(.7,p.form-.05));
    // å¹´æœ«
    if(mo===11&&d===31){this._yearEnd(y);return;}
    // éšæœºäº‹ä»¶
    if(Math.random()<.01)this._randomEvent();
    // èµ›äº‹
    const ev=Cal.today(this.date);
    if(ev){
      if(ev.isReg){Tour.start(ev);return;}
      else{
        const w=pick(World.teams);
        if(w&&w.roster){w.roster.forEach(p=>{p.ys.matches+=5;p.ys.ratingSum+=(1.05+Math.random()*.2)*5;p.ys.wins++;if(ev.tier==='major')p.ys.majorWins++;});if(w.roster[0])w.roster[0].ys.mvps++;}
        UI.toast(`ğŸ“° ${w?w.name:'æŸé˜Ÿ'} å¤ºå¾— ${ev.name} å† å†›ï¼`);
      }
    }
    UI.refresh();
  },
  _checkDebuts(y){
    Object.values(HISTORICAL_DATA).forEach(era=>{
      if(!era||!era.players)return;
      Object.values(era.players).forEach(cfg=>{
        if(cfg.debutYear!==y)return;
        const exists=World.players.some(p=>p.isReal&&(p.handle===cfg.name||p.realName===cfg.realName));
        if(exists)return;
        const baseCfg={...cfg};if(cfg.debutAge)baseCfg.age=cfg.debutAge;
        const firstTeamId=cfg.firstTeamId||null;
        const teamTarget=firstTeamId?World.teams.find(t=>t.id===firstTeamId||t.name===firstTeamId)||null:null;
        const p=World.mkRealPlayer(baseCfg,teamTarget?teamTarget.id:null);
        World.players.push(p);
        if(teamTarget){p.teamId=teamTarget.id;teamTarget.roster.push(p);}
        else{Market.pList.push(p);}
        this.pushNews(`[æœªæ¥ä¹‹æ˜Ÿ] ${cfg.debutAge||16}å²å¤©æ‰ ${cfg.name} å·²å´­éœ²å¤´è§’ï¼`);
      });
    });
  },
  _yearEnd(y){
    // è€å°†ä¸‹æ»‘ï¼ˆå»é‡å¤„ç†ï¼Œroster ä¸ World.players æœ‰é‡å ï¼‰
    const seen=new Set();
    [...this.roster,...World.players].forEach(p=>{
      if(seen.has(p.id))return;seen.add(p.id);
      p.age++;
      if(p.age>30){
        // ä¸è€ç¥è¯ï¼ˆf0restç­¾åç‰¹è´¨ï¼‰ï¼šæ°¸ä¹…å…ç–«å¹´é¾„ä¸‹æ»‘
        if((p.traits||[]).includes('sig_f0rest'))return;
        if(p.age<=34&&Math.random()<.15){
          const drop=rnd(1,2);p.rating=Math.max(40,p.rating-drop);p.potential=Math.max(p.rating,p.potential-1);
          if(p.teamId==='PLAYER')UI.toast(`âš  ${p.name} å¹´é¾„å¢é•¿ï¼ŒçŠ¶æ€ä¸‹æ»‘ï¼ˆ-${drop}ï¼‰`);
        }
        if(p.age>=35&&p.teamId==='PLAYER'){
          this.roster=this.roster.filter(x=>x.id!==p.id);p.teamId=null;
          UI.toast(`ğŸ“¢ ${p.name} å·²å¹´æ»¡35å²å®£å¸ƒé€€å½¹ã€‚`);
        }
      }
    });
    if(this.coach&&this.coach.age>=40&&Math.random()<.05){UI.toast(`ğŸ“¢ æ•™ç»ƒ ${this.coach.name} é€‰æ‹©ç¦»é˜Ÿã€‚`);this.coach=null;}
    if(this.coach)this.coach.age++;
    this._aiTransfer(y);
    HLTV.calc(y);
    Cal.genYear(y+1);
  },
  _aiTransfer(y){
    const weakTeams=World.teams.filter(t=>!t.isPlayer).sort((a,b)=>a.rating-b.rating).slice(0,4);
    weakTeams.forEach(t=>{
      if(!t.roster||t.roster.length===0)return;
      const canKick=t.roster.filter(p=>!(p.isReal&&p.rarity==='legend'));
      const worstP=(canKick.length>0?canKick:t.roster).reduce((a,b)=>a.rating<b.rating?a:b);
      t.roster=t.roster.filter(p=>p.id!==worstP.id);worstP.teamId=null;
      const bestFA=World.players.filter(p=>!p.teamId&&p.rating>worstP.rating+2).sort((a,b)=>b.rating-a.rating)[0];
      if(bestFA){bestFA.teamId=t.id;t.roster.push(bestFA);this.pushNews(`âš¡ ${t.name} ç­¾ä¸‹ ${bestFA.name}`);}
      else{const newP=World.mkP(worstP.rating+2,worstP.rating+8,true,worstP.role,y);newP.teamId=t.id;World.players.push(newP);t.roster.push(newP);this.pushNews(`âœ¨ ${t.name} ææ‹”é’è®­ ${newP.name}`);}
    });
  },
  _randomEvent(){
    const ev=pick(RANDOM_EVENTS);
    if(ev.target==='player'&&this.roster.length){
      const p=pick(this.roster);const txt=ev.txt.replace('${p}',p.name);ev.effect(p);
      UI.showEventTicker(txt);
    }else if(ev.target==='team'&&ev.teamEffect){ev.teamEffect(this.roster);UI.showEventTicker(ev.txt);}
    else if(ev.target==='chem'){this.chem=Math.max(0,Math.min(this.chemCap(),this.chem+ev.chemEffect));UI.showEventTicker(ev.txt);}
  },
  chemCap(){return this.coach?Math.min(110,100+Math.floor(this.coach.tactics/10)):100;},
  setTrain(m){
    this.training=m;
    document.querySelectorAll('.trbtn').forEach(b=>b.classList.remove('on'));
    const el=document.getElementById('tr-'+m);if(el)el.classList.add('on');
    const d={rest:'ğŸ›Œ æ¢å¤ä½“åŠ›ä¸çŠ¶æ€ï¼Œé™ä½ç–²åŠ³ã€‚',aim:'ğŸ¯ å¼ºåŒ–æªæ³•ï¼Œå‘æ½œåŠ›ä¸Šé™é æ‹¢ï¼ˆæ•™ç»ƒåŠ é€Ÿï¼‰ã€‚',tactics:'ğŸ—º æå‡ç£¨åˆåº¦ï¼Œä¸Šé™ç”±æ•™ç»ƒæˆ˜æœ¯æ°´å¹³å†³å®šã€‚'};
    const td=document.getElementById('tr-desc');if(td)td.innerText=d[m];
  },
  synergy(){
    if(!this.roster.length)return{mult:1,msgs:['<div class="syn" style="border-left-color:var(--dim)">æš‚æ— é€‰æ‰‹</div>']};
    const r=this.roster.map(p=>p.role);
    const igls=r.filter(x=>x==='IGL').length,snipers=r.filter(x=>x==='Sniper').length,entries=r.filter(x=>x==='Entry').length;
    let mult=1,msgs=[];
    if(igls===1){mult+=.05;msgs.push('<div class="syn" style="border-left-color:var(--win);color:#86efac">âœ… æ˜ç¡®æŒ‡æŒ¥ (+5%)</div>');}
    else if(!igls){mult-=.15;msgs.push('<div class="syn" style="border-left-color:var(--loss);color:#fca5a5">âŒ ç¼ºå°‘æŒ‡æŒ¥ (-15%)</div>');}
    else{mult-=.10;msgs.push('<div class="syn" style="border-left-color:var(--gold);color:var(--gold)">âš  æŒ‡æŒ¥æƒå†²çª (-10%)</div>');}
    if(snipers===1){mult+=.05;msgs.push('<div class="syn" style="border-left-color:var(--win);color:#86efac">âœ… ä¸“å±ç‹™å‡» (+5%)</div>');}
    else if(!snipers){mult-=.10;msgs.push('<div class="syn" style="border-left-color:var(--loss);color:#fca5a5">âŒ ç¼ºå°‘ç‹™å‡» (-10%)</div>');}
    else{mult-=.10;msgs.push('<div class="syn" style="border-left-color:var(--gold);color:var(--gold)">âš  ç‹™å‡»è¿‡å¤š (-10%)</div>');}
    if(entries>=1){mult+=.02;msgs.push('<div class="syn" style="border-left-color:var(--win);color:#86efac">âœ… æœ‰çªç ´æ‰‹ (+2%)</div>');}
    else{mult-=.05;msgs.push('<div class="syn" style="border-left-color:var(--loss);color:#fca5a5">âŒ ç¼ºå°‘çªç ´æ‰‹ (-5%)</div>');}
    if(this.coach){mult+=.03;msgs.push(`<div class="syn" style="border-left-color:var(--blue);color:#93c5fd">ğŸ§  æ•™ç»ƒåŠ æŒï¼ˆæˆ˜æœ¯${this.coach.tactics}ï¼‰(+3%)</div>`);}
    this.synCache={mult,msgs};return this.synCache;
  },
  power(){
    let raw=this.roster.reduce((s,p)=>s+p.rating*p.form,0)/(this.roster.length||1);
    if(this.fatigue>50)raw*=.9;
    const syn=this.synergy();let synMult=syn.mult;
    const hasTactBrain=this.roster.some(p=>(p.traits||[]).some(t=>t==='sig_karrigan'||t==='sig_gla1ve'));
    let tactMult=1;
    if(hasTactBrain){if(synMult<1)synMult=1;tactMult=1.1;}
    return{raw,eff:raw*synMult*(1+this.chem/500)*tactMult};
  },
  buyP(id){
    if(this.roster.length>=5)return UI.toast('é˜µå®¹å·²æ»¡ï¼');
    const p=Market.pList.find(x=>x.id===id);if(!p)return;
    const isRealLegend=p.isReal&&p.rarity==='legend';
    const required=isRealLegend?Math.ceil(p.price*1.5):p.price;
    if(this.money<required)return UI.toast(isRealLegend?`ä¼ å¥‡é€‰æ‰‹éœ€è‡³å°‘ $${required.toLocaleString()}`:'èµ„é‡‘ä¸è¶³ï¼');
    this.money-=required;p.teamId='PLAYER';this.roster.push(p);this.chem=Math.max(0,this.chem-15);
    Market.pList=Market.pList.filter(x=>x.id!==id);
    UI.toast(isRealLegend?`âœ é‡é‡‘ç­¾ä¸‹ä¼ å¥‡: ${p.name}`:`âœ ç­¾ä¸‹: ${p.name}`);UI.refresh();Market.renderAll();
  },
  buyC(id){
    const c=Market.cList.find(x=>x.id===id);if(!c)return;
    if(this.money<c.price)return UI.toast('èµ„é‡‘ä¸è¶³ï¼');
    if(this.coach)UI.toast(`ğŸ“¢ å·²è§£é›‡åŸæ•™ç»ƒ ${this.coach.name}`);
    this.money-=c.price;c.teamId='PLAYER';this.coach=c;
    Market.cList=Market.cList.filter(x=>x.id!==id);
    UI.toast(`âœ ç­¾çº¦æ•™ç»ƒ: ${c.name}ï¼ˆæˆ˜æœ¯${c.tactics}ï¼‰`);UI.refresh();Market.renderAll();
  },
  fireP(id){
    if(this.roster.length<=1)return UI.toast('è‡³å°‘ä¿ç•™ä¸€åé€‰æ‰‹ï¼');
    const p=this.roster.find(x=>x.id===id);if(p)p.teamId=null;
    this.roster=this.roster.filter(x=>x.id!==id);UI.refresh();
  },
  fireC(){if(!this.coach)return;UI.toast(`è§£é›‡äº†æ•™ç»ƒ ${this.coach.name}`);this.coach.teamId=null;this.coach=null;UI.refresh();},
  skipToEvent(){
    // æœ€å¤šæ¨è¿› 400 å¤©é˜²æ­¢æ­»å¾ªç¯
    for(let i=0;i<400;i++){
      this.advanceDay();
      if(!document.getElementById('pnl-hub').classList.contains('hidden'))break;
      if(!document.getElementById('hltv-modal').classList.contains('hidden'))break;
    }
  }
};

// â”€â”€â”€ Calendar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Cal={
  evs:[],
  tierFormats:{
    'major': {groupBo:1,knockoutBo:3,finalBo:5,teams:16},
    'a-tier':{groupBo:1,knockoutBo:3,finalBo:3,teams:16},
    'c-tier':{groupBo:1,knockoutBo:1,finalBo:1,teams:8}
  },
  genYear(y){
    this.evs=[];
    this.add(y,1,15,'IEM å¡æ‰˜ç»´å…¹','a-tier');
    this.add(y,4,10,'PGL å·´é» Major','major');
    this.add(y,6,5,'ESL One ç§‘éš†','a-tier');
    this.add(y,10,1,'BLAST å…¨çƒæ€»å†³èµ›','major');
    for(let m=0;m<12;m++)if(![1,4,6,10].includes(m))this.add(y,m,rnd(10,20),`CCT çº¿ä¸Š #${m+1}`,'c-tier');
    this.evs.sort((a,b)=>a.date-b.date);UI.renderCal();
  },
  add(y,mo,d,name,tier){
    const tf=this.tierFormats[tier];
    const prize=tier==='major'?1250000:tier==='a-tier'?500000:50000;
    const minFans=tier==='major'?3000:tier==='a-tier'?1000:100;
    this.evs.push({id:'t'+rnd(1000,9999),date:new Date(y,mo,d),name,tier,teams:tf.teams,prize,minFans,isReg:false,fmt:tf});
  },
  today(dt){const s=fmtD(dt);return this.evs.find(e=>fmtD(e.date)===s)||null;},
  register(id){
    const ev=this.evs.find(e=>e.id===id);if(!ev)return;
    if(Game.fans<ev.minFans)return UI.toast('ç²‰ä¸ä¸è¶³ï¼');
    if(Game.roster.length<5)return UI.toast('é˜µå®¹ä¸æ»¡5äººï¼');
    ev.isReg=true;UI.toast(`âœ… æŠ¥å: ${ev.name}`);UI.renderCal();
  },
  boLabel(bo){return bo===1?'BO1':bo===3?'BO3':'BO5';}
};

// â”€â”€â”€ HLTV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const HLTV={
  calc(y){
    World.players.forEach(p=>{
      const m=Math.max(1,p.ys.matches);const avg=m<5?.5:p.ys.ratingSum/m;
      p._sc=avg*60+p.ys.mvps*15+p.ys.majorWins*10+p.ys.wins*5;
      if(p.ys.matches>0){if(!p.history)p.history=[];p.history.push({year:y,team:p.teamId==='PLAYER'?'æˆ‘çš„æˆ˜é˜Ÿ':(p.teamId||'FA'),rating:avg.toFixed(2),mvps:p.ys.mvps});}
    });
    const top=[...World.players].sort((a,b)=>b._sc-a._sc).slice(0,20);
    const el=document.getElementById('hltv-year');if(el)el.innerText=`Player of the Year ${y}`;
    const list=document.getElementById('hltv-list');
    if(list)list.innerHTML=top.map((p,i)=>{
      const avg=p.ys.matches>0?(p.ys.ratingSum/p.ys.matches).toFixed(2):'0.00';
      const team=p.teamId==='PLAYER'?'YOUR TEAM':(p.teamId||'FA');
      return`<div class="hrow ${i<3?'top3':''}">
        <div class="hrank">#${i+1}</div>
        <div style="font-size:16px;font-weight:700;color:#fff;flex:1;margin-left:14px">${p.name} <span style="font-size:11px;color:var(--dim)">[${team}]</span></div>
        <div style="display:flex;gap:18px;font-size:12px;color:var(--dim);text-align:right">
          <div style="width:70px">Matches<br><b style="color:var(--fg)">${p.ys.matches}</b></div>
          <div style="width:90px">Rating 2.0<br><b style="color:#fff">${avg}</b></div>
          <div style="width:60px">MVPs<br><b style="color:var(--mvp)">${p.ys.mvps}</b></div>
        </div>
      </div>`;
    }).join('');
    const modal=document.getElementById('hltv-modal');if(modal)modal.classList.remove('hidden');
    World.players.forEach(p=>p.ys={matches:0,ratingSum:0,mvps:0,majorWins:0,wins:0});
  }
};

// â”€â”€â”€ BPï¼ˆBan/Pickï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ã€ä¿®å¤ã€‘åˆå¹¶äº†åŸæ¥ä¸¤ä¸ªäº’ç›¸å†²çªçš„ start() å‡½æ•°ï¼Œç»Ÿä¸€å˜é‡å‘½å
const BP={
  maps:[],steps:[],stepIdx:0,
  playerBans:[],playerPicks:[],
  aiBans:[],aiPicks:[],
  decider:null,    // string: å¤©å›¾åœ°å›¾å
  oppTeam:null,
  boFormat:1,
  mapStrP:[],   // [{map, str}]
  mapStrAI:[],  // [{map, str}]

  start(){
    // ä» Tour è·å–å¯¹æ‰‹ä¿¡æ¯
    const round=Tour.rounds[Tour.playerRound];
    if(!round)return UI.toast('èµ›ç¨‹æ•°æ®å¼‚å¸¸ï¼');
    const idx=Tour.playerMatchIdx;
    const m=round[idx];
    if(!m||!m.t1||!m.t2)return UI.toast('å¯¹æ‰‹ä¿¡æ¯å¼‚å¸¸ï¼');

    this.oppTeam=m.t1.isPlayer?m.t2:m.t1;
    this.boFormat=Tour.currentBo();
    const y=Game.date.getFullYear();
    this.maps=[...MapUtils.poolForYear(y)];

    // è®¡ç®—åŒæ–¹å„å›¾å®åŠ›
    this.mapStrP=MapUtils.teamPoolRatings(Game.roster,Game.coach,y);
    this.mapStrAI=MapUtils.teamPoolRatings(this.oppTeam.roster,this.oppTeam.coach||null,y);

    // karrigan æˆ˜æœ¯å¤§å¸ˆï¼šç›´æ¥å°é”å¯¹æ–¹æœ€å¼ºå›¾
    const hasKarrigan=Game.roster.some(p=>(p.traits||[]).some(t=>t==='sig_karrigan'||t==='sig_gla1ve'));
    if(hasKarrigan&&this.mapStrAI.length>0){
      const bestMap=[...this.mapStrAI].sort((a,b)=>b.str-a.str)[0].map;
      this.maps=this.maps.filter(map=>map!==bestMap);
      this.mapStrP=this.mapStrP.filter(x=>x.map!==bestMap);
      this.mapStrAI=this.mapStrAI.filter(x=>x.map!==bestMap);
      UI.toast(`ğŸ§  æˆ˜æœ¯å¤§è„‘ç”Ÿæ•ˆï¼ç›´æ¥Banæ‰äº†å¯¹æ‰‹å¼ºå›¾ ${MapUtils.display(bestMap)}`);
    }

    // ç”ŸæˆBPæ­¥éª¤
    this.playerBans=[];this.playerPicks=[];
    this.aiBans=[];this.aiPicks=[];
    this.decider=null;this.stepIdx=0;this.steps=[];

    if(this.boFormat===1){
      // BO1: åŒæ–¹å„banä¸€å¼ ï¼Œå‰©ä½™éšæœºé€‰ä¸€å¼ 
      this.steps=[
        {actor:'player',action:'ban'},{actor:'ai',action:'ban'}
      ];
    }else if(this.boFormat===3){
      // BO3: banÃ—2å„æ–¹, pickÃ—1å„æ–¹, å¤©å›¾Ã—1
      this.steps=[
        {actor:'player',action:'ban'},{actor:'ai',action:'ban'},
        {actor:'player',action:'ban'},{actor:'ai',action:'ban'},
        {actor:'player',action:'pick'},{actor:'ai',action:'pick'}
        // å‰©ä½™1å¼ =å¤©å›¾ï¼Œåœ¨_finishä¸­å¤„ç†
      ];
    }else{
      // BO5: banÃ—1å„æ–¹, pickÃ—2å„æ–¹, å¤©å›¾Ã—1
      this.steps=[
        {actor:'player',action:'ban'},{actor:'ai',action:'ban'},
        {actor:'player',action:'pick'},{actor:'ai',action:'pick'},
        {actor:'player',action:'pick'},{actor:'ai',action:'pick'}
        // å‰©ä½™1å¼ =å¤©å›¾
      ];
    }
    this.steps.forEach(s=>{s.done=false;s.map=null;});

    const overlay=document.getElementById('bp-overlay');
    if(overlay)overlay.classList.remove('hidden');
    this.render();
    this._checkAutoStep();
  },

  _availMaps(){
    const used=new Set([...this.playerBans,...this.aiBans,...this.playerPicks,...this.aiPicks]);
    if(this.decider)used.add(this.decider);
    return this.maps.filter(m=>!used.has(m));
  },

  _checkAutoStep(){
    if(this.stepIdx>=this.steps.length){this._finish();return;}
    const step=this.steps[this.stepIdx];
    if(step.actor==='ai'){setTimeout(()=>this._aiStep(),600);}
  },

  _aiStep(){
    if(this.stepIdx>=this.steps.length){this._finish();return;}
    const step=this.steps[this.stepIdx];
    const avail=this._availMaps();
    if(!avail.length){this._finish();return;}
    const tactics=(this.oppTeam&&this.oppTeam.coach)?this.oppTeam.coach.tactics:50;
    const precision=.4+tactics*.005;
    let chosen;
    if(step.action==='ban'){
      const sorted=[...this.mapStrP].filter(x=>avail.includes(x.map)).sort((a,b)=>b.str-a.str);
      chosen=(Math.random()<precision&&sorted.length>0)?sorted[0].map:pick(avail);
      this.aiBans.push(chosen);
    }else{
      const sorted=[...this.mapStrAI].filter(x=>avail.includes(x.map)).sort((a,b)=>b.str-a.str);
      chosen=(Math.random()<precision&&sorted.length>0)?sorted[0].map:pick(avail);
      this.aiPicks.push(chosen);
    }
    step.done=true;step.map=chosen;
    this.stepIdx++;
    this.render();
    this._checkAutoStep();
  },

  playerClick(map){
    if(this.stepIdx>=this.steps.length)return;
    const step=this.steps[this.stepIdx];
    if(step.actor!=='player')return;
    const avail=this._availMaps();
    if(!avail.includes(map))return;
    if(step.action==='ban')this.playerBans.push(map);
    else this.playerPicks.push(map);
    step.done=true;step.map=map;
    this.stepIdx++;
    this.render();
    this._checkAutoStep();
  },

  _finish(){
    const avail=this._availMaps();
    // å¤©å›¾
    if(avail.length>0){
      if(this.boFormat===1){
        // BO1: å‰©ä½™éšæœºé€‰ä¸€å¼ ä½œä¸ºå”¯ä¸€å›¾
        const chosen=pick(avail);
        this.decider=chosen;
        this.playerPicks=[chosen]; // BO1 åªæœ‰è¿™ä¸€å¼ å›¾
      }else{
        this.decider=pick(avail);
      }
    }
    // æ„å»ºç³»åˆ—èµ›åœ°å›¾é¡ºåºï¼ˆé‡ç½® Tour çš„ç³»åˆ—èµ›çŠ¶æ€ï¼‰
    let seriesMaps=[];
    if(this.boFormat===1){
      seriesMaps=[this.playerPicks[0]||this.decider||this.maps[0]];
    }else{
      // BO3: p-pick, ai-pick, decider
      // BO5: p-pick1, ai-pick1, p-pick2, ai-pick2, decider
      // äº¤æ›¿é¡ºåºæ’åˆ—
      const maxPicks=this.boFormat===3?1:2;
      for(let i=0;i<maxPicks;i++){
        if(this.playerPicks[i])seriesMaps.push(this.playerPicks[i]);
        if(this.aiPicks[i])seriesMaps.push(this.aiPicks[i]);
      }
      if(this.decider)seriesMaps.push(this.decider);
    }

    // ã€å…³é”®ä¿®å¤ã€‘ç»Ÿä¸€é‡ç½®ç³»åˆ—èµ›çŠ¶æ€
    Tour.seriesMaps=seriesMaps;
    Tour.seriesMapIdx=0;
    Tour.seriesWinsP=0;
    Tour.seriesWinsAI=0;
    Tour._mapResults=[];

    const overlay=document.getElementById('bp-overlay');
    if(overlay)overlay.classList.add('hidden');
    Match.beginSeries();
  },

  render(){
    const step=this.stepIdx<this.steps.length?this.steps[this.stepIdx]:null;
    const avail=this._availMaps();
    const bo=this.boFormat;

    const bpTitle=document.getElementById('bp-title');
    const bpSub=document.getElementById('bp-sub');
    const bpPhase=document.getElementById('bp-phase');
    if(bpTitle)bpTitle.innerText=`åœ°å›¾ Ban/Pick â€” ${Cal.boLabel(bo)}`;
    if(bpSub)bpSub.innerHTML=`å¯¹é˜µ: ${this.oppTeam?teamNameWithStar(this.oppTeam.name):''}`;

    let phaseText='';
    if(!step){phaseText='BP å®Œæˆï¼Œå³å°†å¼€å§‹æ¯”èµ›...';}
    else{phaseText=`${step.actor==='player'?'â–¶ ä½ çš„æ“ä½œ':'â³ å¯¹æ‰‹æ“ä½œä¸­...'} â€” ${step.action==='ban'?'é€‰æ‹© BAN æ‰ä¸€å¼ åœ°å›¾':'é€‰æ‹© PICK ä¸€å¼ åœ°å›¾'}`;}
    if(bpPhase)bpPhase.innerText=phaseText;

    // æ§½ä½æ•°é‡
    const banCount=bo===5?1:2;
    const pickCount=bo===1?0:bo===3?1:2;
    const pBanSlots=Array(banCount).fill(null).map((_,i)=>this.playerBans[i]);
    const aiBanSlots=Array(banCount).fill(null).map((_,i)=>this.aiBans[i]);
    const pPickSlots=Array(pickCount).fill(null).map((_,i)=>this.playerPicks[i]);
    const aiPickSlots=Array(pickCount).fill(null).map((_,i)=>this.aiPicks[i]);

    const slotHtml=(slots,type)=>slots.map(m=>`<div class="bp-pick-slot ${m?('filled-'+type):''}">${m?MapUtils.display(m):'â€”'}</div>`).join('');
    const bpStatus=document.getElementById('bp-status');
    if(bpStatus)bpStatus.innerHTML=`
      <div class="bp-team">
        <div class="bp-team-name" style="color:var(--win)">ğŸ›¡ æˆ‘çš„æˆ˜é˜Ÿ</div>
        <div style="font-size:10px;color:var(--dim);margin-bottom:4px">BAN</div>
        <div class="bp-picks-row">${slotHtml(pBanSlots,'loss')}</div>
        ${bo>1?`<div style="font-size:10px;color:var(--dim);margin:6px 0 4px">PICK</div><div class="bp-picks-row">${slotHtml(pPickSlots,'win')}</div>`:''}
      </div>
      <div style="font-size:24px;color:var(--dim);align-self:center">âš”</div>
      <div class="bp-team">
        <div class="bp-team-name" style="color:var(--loss)">ğŸ”« ${this.oppTeam?teamNameWithStar(this.oppTeam.name):''}</div>
        <div style="font-size:10px;color:var(--dim);margin-bottom:4px">BAN</div>
        <div class="bp-picks-row">${slotHtml(aiBanSlots,'loss')}</div>
        ${bo>1?`<div style="font-size:10px;color:var(--dim);margin:6px 0 4px">PICK</div><div class="bp-picks-row">${slotHtml(aiPickSlots,'loss')}</div>`:''}
      </div>`;

    const bpMaps=document.getElementById('bp-maps');
    if(bpMaps)bpMaps.innerHTML=this.maps.map(map=>{
      const isBannedP=this.playerBans.includes(map),isBannedAI=this.aiBans.includes(map);
      const isPickedP=this.playerPicks.includes(map),isPickedAI=this.aiPicks.includes(map);
      const isDecider=this.decider===map;
      const isAvail=avail.includes(map);
      const canClick=step?.actor==='player'&&isAvail;
      const strP=(this.mapStrP.find(x=>x.map===map)||{str:50}).str;
      const strAI=(this.mapStrAI.find(x=>x.map===map)||{str:50}).str;
      let cls='bp-map';
      if(isBannedP||isBannedAI)cls+=' banned';
      else if(isPickedP)cls+=' picked-p';
      else if(isPickedAI)cls+=' picked-ai';
      else if(isDecider)cls+=' decider';
      else if(!canClick)cls+=' disabled';
      let label='';
      if(isBannedP)label='<div style="font-size:9px;color:var(--loss)">BANï¼ˆå·±æ–¹ï¼‰</div>';
      else if(isBannedAI)label='<div style="font-size:9px;color:var(--loss)">BANï¼ˆå¯¹æ–¹ï¼‰</div>';
      else if(isPickedP)label='<div style="font-size:9px;color:var(--win)">PICKï¼ˆå·±æ–¹ï¼‰</div>';
      else if(isPickedAI)label='<div style="font-size:9px;color:var(--loss)">PICKï¼ˆå¯¹æ–¹ï¼‰</div>';
      else if(isDecider)label='<div style="font-size:9px;color:var(--purple)">å¤©å›¾</div>';
      else{const diff=strP-strAI;label=`<div style="font-size:9px;color:${diff>5?'var(--win)':diff<-5?'var(--loss)':'var(--dim)'}">${diff>5?'æˆ‘æ–¹ä¼˜åŠ¿':diff<-5?'å¯¹æ–¹ä¼˜åŠ¿':'åŠ¿å‡åŠ›æ•Œ'}</div>`;}
      return`<div class="${cls}" onclick="BP.playerClick('${map}')">
        <div class="bp-map-name">${MapUtils.display(map)}</div>
        ${label}
        <div class="bp-map-bars">
          <div class="bp-bar" style="background:var(--win);width:${strP*.7}px" title="æˆ‘æ–¹:${strP}"></div>
          <div class="bp-bar" style="background:var(--loss);width:${strAI*.7}px" title="å¯¹æ–¹:${strAI}"></div>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--dim);margin-top:3px"><span>${strP}</span><span>${strAI}</span></div>
      </div>`;
    }).join('');
  }
};

// â”€â”€â”€ Tour â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Tour={
  ev:null,rounds:[],phase:'idle',
  playerRound:-1,playerMatchIdx:-1,
  pStats:new Map(),prize:0,
  // ç³»åˆ—èµ›çŠ¶æ€ï¼ˆç”± BP._finish() ç»Ÿä¸€è®¾ç½®ï¼‰
  seriesMaps:[],seriesMapIdx:0,
  seriesWinsP:0,seriesWinsAI:0,
  _mapResults:[],

  start(ev){
    this.ev=ev;this.pStats.clear();this.prize=0;this.phase='hub';
    this.playerRound=0;this.playerMatchIdx=-1;
    // é‡ç½®ç³»åˆ—èµ›çŠ¶æ€
    this.seriesMaps=[];this.seriesMapIdx=0;this.seriesWinsP=0;this.seriesWinsAI=0;this._mapResults=[];

    const playerTeam={id:'__player__',name:'æˆ‘çš„æˆ˜é˜Ÿ',rating:Game.power().eff,isPlayer:true,roster:Game.roster,coach:Game.coach};
    Game.roster.forEach(p=>this._initT(p,playerTeam));

    const pool=[...World.teams].sort(()=>Math.random()-.5);
    const all=[playerTeam];
    for(let i=1;i<ev.teams;i++){
      const t=pool[i-1];if(!t)break;
      all.push(t);t.roster.forEach(p=>this._initT(p,t));
    }
    all.sort(()=>Math.random()-.5);

    this.rounds=[];
    const cur=[];
    for(let i=0;i<all.length;i+=2)cur.push({t1:all[i],t2:all[i+1]||null,winner:null});
    this.rounds.push(cur);
    let n=cur.length;
    while(n>1){n=Math.ceil(n/2);this.rounds.push(Array.from({length:n},()=>({t1:null,t2:null,winner:null})));}

    // æ‰¾åˆ°ç©å®¶å¯¹æ‰‹ä½ç½®
    const playerIdx=this.rounds[0].findIndex(m=>m.t1?.isPlayer||m.t2?.isPlayer);
    this.playerMatchIdx=playerIdx;

    // å¤„ç† byeï¼ˆå¯¹æ‰‹ä¸º nullï¼Œç›´æ¥æ™‹çº§ï¼‰
    this.rounds[0].forEach((m,idx)=>{
      if(!m.t2){m.winner=m.t1;this._promote(0,idx,m.t1);}
    });

    this._simAI(0);
    UI.showHub();
  },

  currentBo(){
    if(!this.ev)return 1;
    const fmt=this.ev.fmt;
    const maxR=this.rounds.length-1;
    if(this.playerRound===maxR)return fmt.finalBo;
    if(this.playerRound>=maxR-1)return fmt.knockoutBo;
    return fmt.groupBo;
  },

  _initT(p,team){
    if(!this.pStats.has(p.id))
      this.pStats.set(p.id,{player:p,team,played:0,score:0,topRating:0,finalRating:null});
  },

  _simAI(roundIdx){
    const matches=this.rounds[roundIdx];if(!matches)return;
    const isFinal=roundIdx===this.rounds.length-1;
    matches.forEach((m,idx)=>{
      if(m.winner||!m.t1||!m.t2||m.t1.isPlayer||m.t2.isPlayer)return;
      const t1w=(m.t1.rating||70)*(0.8+Math.random()*.4)>(m.t2.rating||70)*(0.8+Math.random()*.4);
      m.winner=t1w?m.t1:m.t2;
      this._promote(roundIdx,idx,m.winner);
      const fake=(roster,win)=>roster.forEach(p=>{
        const r=(win?0.95+Math.random()*.4:0.7+Math.random()*.4)*p.form;
        const sc=0.35*r+0.20*(r*.9)+Math.random()*.2;
        const tr=this.pStats.get(p.id);
        if(tr){tr.played++;tr.score+=sc*(isFinal?1.6:1.1);if(r>tr.topRating)tr.topRating=r;if(isFinal)tr.finalRating=r;}
        p.ys.matches++;p.ys.ratingSum+=parseFloat(r.toFixed(2));
      });
      fake(m.t1.roster||[],t1w);fake(m.t2.roster||[],!t1w);
    });
  },

  _promote(roundIdx,matchIdx,winner){
    const next=this.rounds[roundIdx+1];if(!next)return;
    const slot=next[Math.floor(matchIdx/2)];
    if(slot){if(matchIdx%2===0)slot.t1=winner;else slot.t2=winner;}
  },

  _advWin(winner){
    this._promote(this.playerRound,this.playerMatchIdx,winner);
    this.playerRound++;
    if(this.playerRound>=this.rounds.length){this.phase='done';this._finalize(winner);return;}
    this._simAI(this.playerRound);
    const newIdx=this.rounds[this.playerRound].findIndex(m=>m.t1?.isPlayer||m.t2?.isPlayer);
    this.playerMatchIdx=newIdx;
    // é‡ç½®ç³»åˆ—èµ›çŠ¶æ€ï¼Œå‡†å¤‡ä¸‹ä¸€åœº
    this.seriesMaps=[];this.seriesMapIdx=0;this.seriesWinsP=0;this.seriesWinsAI=0;this._mapResults=[];
    this.phase='hub';UI.showHub();
  },

  _advLoss(aiWinner){
    // ã€ä¿®å¤ã€‘å‡½æ•°åªæ¥å—1ä¸ªå‚æ•°
    this._promote(this.playerRound,this.playerMatchIdx,aiWinner);
    this.phase='eliminated';
    for(let r=this.playerRound+1;r<this.rounds.length;r++)this._simAI(r);
    const finalWinner=this.rounds[this.rounds.length-1][0]?.winner;
    this._finalize(finalWinner||aiWinner);
  },

  _finalize(champ){
    let cands=[...this.pStats.values()].filter(t=>t.played>0).map(t=>({
      ...t,avgScore:t.score/t.played,
      mvpElig:t.topRating>=1.15&&(t.finalRating===null||t.finalRating>=1.0)&&(t.team.id===champ.id||Math.random()<.05)
    })).sort((a,b)=>b.avgScore-a.avgScore);
    const mvp=cands.find(c=>c.mvpElig)||cands[0];
    const evps=cands.filter(c=>c.player.id!==mvp?.player.id).slice(0,5);
    if(mvp)mvp.player.ys.mvps++;
    (champ.roster||[]).forEach(p=>{p.ys.wins++;if(this.ev.tier==='major')p.ys.majorWins++;});
    if(champ.isPlayer){
      Game.trophies.push({event:this.ev.name,date:new Date(Game.date),rank:'Champion',prize:this.prize});
      Game.fans+=Math.floor(this.ev.prize/500);
      SaveManager.save();
    }
    const maxR=this.rounds.length-1;
    let rank='ğŸ† èµ›äº‹æ€»å† å†›',prize=0;
    if(!champ.isPlayer){
      const fromF=maxR-this.playerRound;
      if(fromF===0){rank='ğŸ¥ˆ äºšå†›';prize=Math.floor(this.ev.prize*.4);}
      else if(fromF===1){rank='ğŸ¥‰ å››å¼º';prize=Math.floor(this.ev.prize*.15);}
      else if(fromF===2){rank='ğŸ… å…«å¼º';prize=Math.floor(this.ev.prize*.05);}
      else{rank='ğŸ’” é—æ†¾å‡ºå±€';}
    }else{prize=this.ev.prize;rank='ğŸ† èµ›äº‹æ€»å† å†›';}
    this.prize=prize;
    UI.renderAwards(mvp,evps,champ,rank,prize);
  },

  recordStats(arr,isFinal){
    const maxR=this.rounds.length-1;
    const w=this.playerRound===maxR?1.6:this.playerRound===maxR-1?1.3:1.1;
    arr.forEach(ps=>{
      const t=this.pStats.get(ps.id);if(!t)return;
      t.played++;t.score+=ps.score*(isFinal?w*1.25:w);
      if(ps.rating>t.topRating)t.topRating=ps.rating;
      if(isFinal)t.finalRating=ps.rating;
    });
  },

  quit(){this.ev=null;this.phase='idle';UI.page('schedule');},

  closeAwards(){
    if(this.prize>0){Game.money+=this.prize;Game.fans+=Math.floor(this.prize/200);}
    this.ev=null;this.phase='idle';UI.page('schedule');UI.refresh();
  }
};

// â”€â”€â”€ Match â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Match={
  s:null,
  _autoTimer:null,

  beginSeries(){
    if(!Tour.seriesMaps||Tour.seriesMaps.length===0){
      UI.toast('ç³»åˆ—èµ›åœ°å›¾ä¸ºç©ºï¼Œè¯·é‡æ–°BPï¼');return;
    }
    this._startMap(0);
  },

  _startMap(mapIdx){
    const map=Tour.seriesMaps[mapIdx];
    if(!map){UI.toast('åœ°å›¾æ•°æ®å¼‚å¸¸ï¼');return;}
    const round=Tour.rounds[Tour.playerRound];
    if(!round)return;
    const m=round[Tour.playerMatchIdx];
    if(!m)return;
    const opp=m.t1.isPlayer?m.t2:m.t1;
    const era=Game.eraObj;

    const mkP=p=>({
      id:p.id,name:p.name,rating:p.rating||60,role:p.role,form:p.form||1,ref:p,
      kills:0,assists:0,deaths:0,dmg:0,
      entryK:0,entryA:0,clutch:0,kastR:0,multiK:0,
      rating2:0,score:0,impact:0,adr:0,kast:0,
      // ç‰¹è´¨è§¦å‘çŠ¶æ€ï¼ˆæ¯å¼ åœ°å›¾é‡ç½®ï¼‰
      _legendFlyUsed:false,   // å¤©å¤–é£ä»™ï¼šé¦–æ¬¡æ’­æŠ¥
      _s1mpleActive:false,    // å¤©å¤–é£ä»™ï¼šæœ¬å›åˆæ˜¯å¦æ¿€æ´»
      _leaderLogged:false,    // é¢†è¢–ï¼šé¦–æ¬¡æ’­æŠ¥
      _tactBrainLogged:false  // æˆ˜æœ¯å¤§è„‘ï¼šé¦–æ¬¡æ’­æŠ¥
    });

    const mapBonusP=MapUtils.teamMapStr(Game.roster,Game.coach,map)/100-.5;
    const mapBonusAI=MapUtils.teamMapStr((opp.roster||[]),opp.coach||null,map)/100-.5;

    this.s={
      round:0,era,map,
      winR:era.winR,halfR:era.halfR,target:era.winR,
      sA:0,sB:0,monA:800,monB:800,lsA:0,lsB:0,
      ctIsA:Math.random()>.5,isOT:false,otSeg:0,otSegStart:0,
      opp,matchRef:m,mapBonusP,mapBonusAI,
      tA:(Game.roster||[]).map(mkP),
      tB:(opp.roster||[]).map(mkP),
      over:false
    };

    // æ›´æ–° UI
    const liveOpp=document.getElementById('live-opp');
    if(liveOpp)liveOpp.innerHTML=teamNameWithStar(opp.name);
    const liveTitle=document.getElementById('live-title');
    if(liveTitle)liveTitle.innerText=`â€” ${MapUtils.display(map)} â€” (å›¾ ${mapIdx+1}/${Tour.seriesMaps.length})`;
    const otInd=document.getElementById('ot-ind');
    if(otInd)otInd.classList.add('hidden');
    const matchlog=document.getElementById('matchlog');
    if(matchlog)matchlog.innerHTML='';
    UI.showLive();
    this._updateSeriesBar();
  },

  _updateSeriesBar(){
    const maps=Tour.seriesMaps;
    const bo=Tour.currentBo();
    const need=Math.ceil(bo/2);
    const winsHtml=`<span style="font-size:13px;color:var(--dim)">æˆ‘æ–¹ <b style="color:var(--win)">${Tour.seriesWinsP}</b> : <b style="color:var(--loss)">${Tour.seriesWinsAI}</b> å¯¹æ–¹ | éœ€ <b style="color:var(--gold)">${need}</b> èƒœ</span>`;
    const html=maps.map((m,i)=>{
      let cls='series-map-btn';
      if(i<Tour.seriesMapIdx){
        cls+=' '+(Tour._mapResults[i]==='p'?'won-p':'won-ai');
      }else if(i===Tour.seriesMapIdx)cls+=' active';
      return`<span class="${cls}">${MapUtils.display(m)}</span>`;
    }).join('');
    const bar=document.getElementById('series-bar');
    if(bar)bar.innerHTML=winsHtml+html;
  },

  buyStatus(money,pistol,ot){
    if(pistol)return{lvl:'Eco',name:'æ‰‹æªå±€',mult:.95};
    if(ot)return{lvl:'Full',name:'åŠ æ—¶é•¿æª',mult:1.0};
    if(money>=4200)return{lvl:'Full',name:'é•¿æªå±€',mult:1.0};
    if(money>=2000)return{lvl:'Force',name:'å¼ºèµ·å±€',mult:.65};
    return{lvl:'Eco',name:'çº¯Eå±€',mult:.35};
  },

  round(){
    if(!this.s||this.s.over)return;
    const s=this.s,era=s.era;

    // åŠåœºæ¢è¾¹
    if(!s.isOT&&s.round===era.halfR){
      s.ctIsA=!s.ctIsA;s.monA=800;s.monB=800;s.lsA=0;s.lsB=0;
      UI.log('ğŸ”„ åŠåœºæ¢è¾¹ï¼ˆ$800ï¼‰','spec');
    }
    // OT åˆ¤æ–­
    if(!s.isOT&&s.sA===s.target-1&&s.sB===s.target-1){
      s.isOT=true;s.otSeg++;s.otSegStart=s.round;
      s.target+=4;s.monA=10000;s.monB=10000;s.lsA=0;s.lsB=0;
      const otEl=document.getElementById('ot-ind');if(otEl)otEl.classList.remove('hidden');
      UI.log(`ğŸ”¥ æ¯”åˆ†æŒå¹³ï¼è¿›å…¥OTï¼ˆ$10000ï¼‰`,'spec');
    }
    // OT æ¢è¾¹
    if(s.isOT&&(s.round-s.otSegStart)===3){
      s.ctIsA=!s.ctIsA;s.monA=10000;s.monB=10000;s.lsA=0;s.lsB=0;
      UI.log(`ğŸ”„ OTæ¢è¾¹ï¼ˆ$10000ï¼‰`,'spec');
    }

    s.round++;
    const pistol=!s.isOT?(s.round===1||s.round===era.halfR+1):((s.round-s.otSegStart)===1);
    const bA=this.buyStatus(s.monA,pistol,s.isOT);
    const bB=this.buyStatus(s.monB,pistol,s.isOT);

    const baseP=Game.power().eff*(1+Game.chem/200)*(1+s.mapBonusP*.3);
    const baseAI=((s.tB||[]).reduce((a,b)=>a+b.rating*b.form,0)/Math.max(1,s.tB.length))*1.05*(1+s.mapBonusAI*.3);

    const calcTraitMult=(team,isTeamA,buyInfo)=>{
      let mult=1;
      const myScore=isTeamA?s.sA:s.sB,oppScore=isTeamA?s.sB:s.sA;
      const scoreDiff=myScore-oppScore; // æ­£=é¢†å…ˆï¼Œè´Ÿ=è½å

      team.forEach(p=>{
        const ts=p.ref.traits||[];

        // â”€â”€ A. å¸¸è§„ç‰¹è´¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // çˆ†å¤´æœºå™¨ï¼šæ­¥æªå±€æˆ˜åŠ›+3%
        if(ts.includes('headshot')&&buyInfo.lvl==='Full')mult+=0.03;
        // é¢†è¢–ï¼šIGLä¸Šåœºå…¨é˜Ÿ+4%ï¼Œé¦–æ¬¡è§¦å‘æ—¥å¿—
        if(ts.includes('leader')&&p.role==='IGL'){
          mult+=0.04;
          if(!p._leaderLogged){
            p._leaderLogged=true;
            UI.log(`ğŸ“£ <span style="color:#eab308;font-weight:700">[é¢†è¢–] ${p.name}</span> é¼“èˆå£«æ°”ï¼Œå…¨é˜Ÿæˆ˜åŠ›æå‡ï¼`,'spec');
          }
        }
        // ç¥ç»åˆ€ï¼šæ¯å›åˆéšæœºæ³¢åŠ¨
        if(ts.includes('volatile')){
          const volatileMult=NORMAL_TRAITS.volatile.volatileMin+Math.random()*(NORMAL_TRAITS.volatile.volatileMax-NORMAL_TRAITS.volatile.volatileMin);
          mult*=volatileMult;
        }

        // â”€â”€ C. å†å²ä¸“å±ç­¾åç‰¹è´¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // å¤©å¤–é£ä»™ï¼ˆs1mpleï¼‰ï¼šè½åâ‰¥4åˆ†æ—¶æˆ˜åŠ›+20%ï¼Œå¤šæ€æ¦‚ç‡ç¿»å€
        if(ts.includes('sig_s1mple')&&scoreDiff<=-SIGNATURE_TRAITS.sig_s1mple.gapTrigger){
          mult+=SIGNATURE_TRAITS.sig_s1mple.powerBonus;
          p._s1mpleActive=true; // ä¾› _micro ä½¿ç”¨
          if(!p._legendFlyUsed){
            p._legendFlyUsed=true;
            UI.log(
              `<span style="color:#ff6b35;font-size:13px">â˜…</span> `+
              `<span style="color:#ffd700;font-weight:900">[â˜…ç­¾åÂ·å¤©å¤–é£ä»™] ${p.name}</span> `+
              `<span style="color:#ff9500">é˜Ÿä¼è½åï¼Œæ¥ç®¡æ¯”èµ›ï¼å¤šæ€æ¦‚ç‡ç¿»å€ï¼</span>`,
              'sig-trigger'
            );
          }
        }else{p._s1mpleActive=false;}

        // è½½ç‰©é¢†åŸŸï¼ˆZyWoOï¼‰ï¼šå…è´Ÿé¢ï¼Œæ‰‹æªå±€ä¸æŠ˜æ‰£ï¼ˆæ­¤å¤„é€šè¿‡ buyMult è¡¥æ­£ï¼‰
        if(ts.includes('sig_zywoo')){
          // æ‰‹æªå±€æœ¬åº” Ã—0.95ï¼Œæ­¤ç‰¹è´¨å¼ºåˆ¶æ¢å¤
          if(pistol&&buyInfo.lvl==='Eco')mult+=(1/0.95-1);
          // çŠ¶æ€ä¸å—è´Ÿé¢å½±å“ï¼ˆform å¼ºåˆ¶â‰¥1.0ï¼‰
          if(p.form<1.0)p.form=1.0;
        }

        // æˆ˜æœ¯å¤§è„‘ï¼ˆkarrigan/gla1veï¼‰ï¼šæ•ˆæœåœ¨ Game.power() å·²å¤„ç†ï¼Œæ­¤å¤„æ—¥å¿—æç¤º
        if(ts.includes('sig_karrigan')||ts.includes('sig_gla1ve')){
          if(!p._tactBrainLogged){
            p._tactBrainLogged=true;
            const sigKey=ts.includes('sig_karrigan')?'sig_karrigan':'sig_gla1ve';
            UI.log(
              `<span style="color:#a78bfa;font-size:13px">â˜…</span> `+
              `<span style="color:#ffd700;font-weight:900">[â˜…ç­¾åÂ·æˆ˜æœ¯å¤§è„‘] ${p.name}</span> `+
              `<span style="color:#c4b5fd">æˆ˜æœ¯ç»Ÿå¾¡ï¼Œæ— è§†Synergyæƒ©ç½šï¼å…¨é˜ŸÃ—1.1</span>`,
              'sig-trigger'
            );
          }
        }
      });
      return mult;
    };

    const traitMultA=calcTraitMult(s.tA,true,bA);
    const traitMultB=calcTraitMult(s.tB,false,bB);
    const pA=baseP*bA.mult*traitMultA*(0.8+Math.random()*.4);
    const pB=baseAI*bB.mult*traitMultB*(0.8+Math.random()*.4);
    const upA=bA.lvl==='Eco'&&bB.lvl==='Full'&&Math.random()<.12;
    const upB=bB.lvl==='Eco'&&bA.lvl==='Full'&&Math.random()<.12;
    const aWins=upA?true:(upB?false:(pA>pB));

    this._micro(aWins?s.tA:s.tB,aWins?s.tB:s.tA);

    const tIsA=!s.ctIsA,bomb=Math.random()<.35;
    let bonA=0,bonB=0;
    if(tIsA&&!aWins&&bomb)bonA=800;
    if(!tIsA&&aWins&&bomb)bonB=800;
    const lbl=s.isOT?`[OT${s.otSeg}Â·R${s.round-s.otSegStart}]`:pistol?'[æ‰‹æª]':`[R${s.round}]`;

    if(aWins){
      s.sA++;s.monA=Math.min(16000,s.monA+3250);
      s.monB=Math.min(16000,s.monB+1400+s.lsB*500+bonB);
      s.lsB=Math.min(4,s.lsB+1);s.lsA=era.lossReset?0:Math.max(0,s.lsA-1);
      if(upA)UI.log(`${lbl} ğŸ”¥ ECOç¿»ç›˜ï¼`,'eco');else UI.log(`${lbl} èµ¢ä¸‹å›åˆã€‚`,'win');
    }else{
      s.sB++;s.monB=Math.min(16000,s.monB+3250);
      s.monA=Math.min(16000,s.monA+1400+s.lsA*500+bonA);
      s.lsA=Math.min(4,s.lsA+1);s.lsB=era.lossReset?0:Math.max(0,s.lsB-1);
      if(upB)UI.log(`${lbl} ğŸ”¥ å¯¹æ‰‹ECOç¿»ç›˜ï¼`,'eco');else UI.log(`${lbl} å›åˆå¤±åˆ©ã€‚`,'loss');
    }
    UI.updateScore();
    if(s.sA>=s.target||s.sB>=s.target)this.end();
  },

  _micro(win,lose){
    const s=this.s;
    // gp = åŠ æƒéšæœºé€‰å–é€‰æ‰‹ï¼ˆçˆ†å¤´æœºå™¨æœ‰æ›´é«˜æƒé‡ï¼‰
    const gp=(team,opp)=>{
      let total=team.reduce((sum,p)=>{
        let w=p.rating*p.form;
        if(opp.some(x=>x.ref.rarity==='legend')&&p.ref.rarity!=='legend')w*=0.95;
        if((p.ref.traits||[]).includes('headshot'))w*=NORMAL_TRAITS.headshot.microWeightMult;
        return sum+w;
      },0);
      let r=Math.random()*total;
      for(const p of team){
        let w=p.rating*p.form;
        if(opp.some(x=>x.ref.rarity==='legend')&&p.ref.rarity!=='legend')w*=0.95;
        if((p.ref.traits||[]).includes('headshot'))w*=NORMAL_TRAITS.headshot.microWeightMult;
        r-=w;if(r<=0)return p;
      }
      return team[0];
    };

    const logKill=(k,v,isEntry)=>{
      const kt=s.tA.includes(k)?'CT':'T',vt=s.tA.includes(v)?'CT':'T';
      const kc=kt==='CT'?'var(--ct)':'var(--t)',vc=vt==='CT'?'var(--ct)':'var(--t)';
      const hasSig=k.ref.traits&&k.ref.traits.some(t=>isSignatureTrait(t));
      const hasLegT=k.ref.traits&&k.ref.traits.some(t=>isAnyLegendTrait(t));
      const kName=hasSig
        ?`<span style="color:#ffd700;font-weight:900;text-shadow:0 0 6px rgba(255,215,0,0.5)">${k.name}</span>`
        :hasLegT?`<span style="color:#ffd700;font-weight:700">${k.name}</span>`
        :k.ref.rarity==='legend'?`<span style="color:#ffd700;font-weight:700">${k.name}</span>`
        :k.name;
      const vName=v.ref.rarity==='legend'||isAnyLegendTrait((v.ref.traits||[])[0])
        ?`<span style="color:#ffd700">${v.name}</span>`:v.name;
      const kIcons=[
        k.ref.rarity==='legend'?'ğŸ‘‘':'',
        (k.ref.traits||[]).includes('headshot')&&Math.random()<0.4?'ğŸ¯':'',  // çˆ†å¤´æœºå™¨é«˜äº®
        hasSig?'â˜…':''
      ].filter(Boolean).join('');
      UI.log(`<span style="color:${kc}">[${kt}] ${kName}</span> ${kIcons} ${isEntry?'ğŸ’¥':'ğŸ”«'} <span style="color:${vc}">[${vt}] ${vName}</span>`,'');
    };

    const entry=win.find(p=>p.role==='Entry')||gp(win,lose),victim=gp(lose,win);
    entry.entryA++;victim.entryA++;
    let ek,ev;
    if(Math.random()<.65){entry.entryK++;entry.kills++;victim.deaths++;entry.dmg+=100;ek=entry;ev=victim;}
    else{victim.entryK++;victim.kills++;entry.deaths++;victim.dmg+=100;ek=victim;ev=entry;}
    if(Math.random()<.5)logKill(ek,ev,true);

    // å¤©å¤–é£ä»™å¤šæ€åŠ æˆï¼šwkåŸºç¡€+50%ï¼ˆå››èˆäº”å…¥ï¼‰
    let wk=Math.floor(Math.random()*2)+4;
    const s1mpleWinner=win.find(p=>(p.ref.traits||[]).includes('sig_s1mple')&&p._s1mpleActive);
    if(s1mpleWinner)wk=Math.round(wk*SIGNATURE_TRAITS.sig_s1mple.multiKillMult*0.6); // ç»¼åˆå¤šæ€æ¦‚ç‡
    const lk=Math.floor(Math.random()*4);

    const km=new Map();
    const addK=(k,v)=>{
      k.kills++;v.deaths++;k.dmg+=80+Math.random()*40;
      km.set(k,(km.get(k)||0)+1);
      if(Math.random()<.25)logKill(k,v,false);
      if(Math.random()<.5){const a=gp(win.includes(k)?win:lose,win.includes(k)?lose:win);if(a!==k){a.assists++;a.dmg+=30+Math.random()*30;}}
    };
    for(let i=1;i<wk;i++)addK(gp(win,lose),gp(lose,win));
    for(let i=(entry.deaths>0?1:0);i<lk;i++)addK(gp(lose,win),gp(win,lose));
    for(const[p,k]of km)if(k>=2)p.multiK++;

    // â”€â”€ æ®‹å±€åˆ¤å®šï¼ˆlk>=3ï¼šå¯¹æ–¹è¿˜æœ‰3äººä»¥ä¸Šï¼Œ1vXåœºæ™¯ï¼‰
    if(lk>=3){
      const sv=gp(win,lose);
      const ts=sv.ref.traits||[];
      const st=s.tA.includes(sv)?'CT':'T',sc=st==='CT'?'var(--ct)':'var(--t)';

      // è®¡ç®—è¯¥é€‰æ‰‹çš„åŸºç¡€clutchæˆåŠŸç‡
      let clutchChance=0.35;
      let clutchMsg='';
      let clutchType='normal'; // normal / legend / sig

      // ç­¾åç‰¹è´¨ï¼šè½½ç‰©é¢†åŸŸï¼ˆZyWoOï¼‰
      if(ts.includes('sig_zywoo')){
        clutchChance=0.35+SIGNATURE_TRAITS.sig_zywoo.clutchBonus;
        clutchMsg=`<span style="color:#ffd700;font-size:13px">â˜…</span> `+
          `<span style="color:#ffd700;font-weight:900">[â˜…ç­¾åÂ·è½½ç‰©é¢†åŸŸ] ${sv.name}</span> `+
          `<span style="color:#00d4ff">åŸŸå±•å¼€ï¼ŒClutchèƒœç‡+55%ï¼</span>`;
        clutchType='sig';
      }
      // ä¼ å¥‡ç‰¹è´¨ï¼šç»å¯¹æ ¸å¿ƒ
      else if(ts.includes('legend_core')){
        clutchChance=0.35+GENERIC_LEGEND_TRAITS.legend_core.clutchPowerBonus+0.15;
        clutchMsg=`<span style="color:#a78bfa;font-size:13px">âœ¦</span> `+
          `<span style="color:#ffd700;font-weight:900">[âœ¦ä¼ å¥‡Â·ç»å¯¹æ ¸å¿ƒ] ${sv.name}</span> `+
          `<span style="color:#c4b5fd">å…¨å±æ€§çˆ†å‘ï¼Œå•æŒ‘å¤šäººï¼</span>`;
        clutchType='legend';
      }
      // å¸¸è§„ç‰¹è´¨ï¼šå¤§å¿ƒè„
      else if(ts.includes('bigHeart')){
        clutchChance=0.35+NORMAL_TRAITS.bigHeart.clutchBonus;
        clutchMsg=`ğŸ’ª <span style="color:#f97316;font-weight:700">[å¤§å¿ƒè„] <span style="color:${sc}">${sv.name}</span></span> ä¸´å±ä¸æƒ§ï¼ŒClutchï¼`;
        clutchType='normal';
      }
      // æ— ç‰¹è´¨ï¼šæ™®é€šæ¦‚ç‡
      else{
        clutchChance=0.35;
        clutchMsg=`ğŸ”¥ <span style="color:${sc};font-weight:900">[${st}] ${sv.name}</span> æé™1vXæ®‹å±€ï¼`;
        clutchType='normal';
      }

      if(Math.random()<clutchChance){
        sv.clutch++;
        if(clutchType==='sig')UI.log(clutchMsg,'sig-trigger');
        else if(clutchType==='legend')UI.log(clutchMsg,'legend-trigger');
        else UI.log(clutchMsg,'spec');
      }
    }

    [...win,...lose].forEach(p=>{if((km.get(p)||0)>0||Math.random()<.3||(win.includes(p)&&Math.random()<.8))p.kastR++;});
  },

  auto(){
    if(this._autoTimer)clearInterval(this._autoTimer);
    this._autoTimer=setInterval(()=>{if(!this.s||this.s.over){clearInterval(this._autoTimer);this._autoTimer=null;}else this.round();},40);
  },

  end(){
    const s=this.s;s.over=true;
    const playerWon=s.sA>s.sB;
    const isFinal=Tour.playerRound===Tour.rounds.length-1;
    const maxR=Tour.rounds.length-1;
    const isSemiOrFinal=isFinal||Tour.playerRound===maxR-1;
    const liveCtrl=document.getElementById('live-ctrl');
    if(liveCtrl)liveCtrl.classList.add('hidden');

    const calc=team=>team.forEach(p=>{
      p.adr=(p.dmg/Math.max(1,s.round)).toFixed(1);
      p.kast=((p.kastR/Math.max(1,s.round))*100).toFixed(1);
      p.impact=Math.max(.5,(p.multiK*.4+p.entryK*.25+p.clutch*.6)).toFixed(2);
      let raw=((p.kills+p.assists*.3)/Math.max(1,p.deaths))*.45+(p.adr/100)*.2+(p.kast/100)*.2+parseFloat(p.impact)*.15;
      if(isSemiOrFinal&&(p.ref.traits||[]).includes('legend_winner')&&raw<GENERIC_LEGEND_TRAITS.legend_winner.minRatingInFinals){
        raw=GENERIC_LEGEND_TRAITS.legend_winner.minRatingInFinals;
        UI.log(
          `<span style="color:#a78bfa;font-size:13px">âœ¦</span> `+
          `<span style="color:#ffd700;font-weight:900">[âœ¦ä¼ å¥‡Â·å¤©ç”Ÿèµ¢å®¶] ${p.name}</span> `+
          `<span style="color:#c4b5fd">å¤§èµ›ç²¾ç¥çˆ†å‘ï¼ŒRatingå¼ºåˆ¶â‰¥1.10ï¼</span>`,
          'legend-trigger'
        );
      }
      p.rating2=raw.toFixed(2);
      const cs=p.clutch*.5,es=p.entryA>0?p.entryK/p.entryA:0;
      p.score=0.35*raw+0.20*parseFloat(p.impact)+0.15*(p.adr/100)+0.10*(p.kast/100)+0.10*cs+0.10*es;
      if(isFinal)p.score*=1.25;
      p.ref.ys.matches++;p.ref.ys.ratingSum+=parseFloat(p.rating2);
    });
    calc(s.tA);calc(s.tB);
    s.tA.sort((a,b)=>b.score-a.score);s.tB.sort((a,b)=>b.score-a.score);
    const all=[...s.tA,...s.tB].sort((a,b)=>b.score-a.score);
    s.mvp=all[0];s.evps=all.slice(1,4).filter(p=>p.rating2>=1.15);
    Tour.recordStats([...s.tA,...s.tB].map(p=>({id:p.id,rating:parseFloat(p.rating2),score:p.score})),isFinal);

    if(!Tour._mapResults)Tour._mapResults=[];
    Tour._mapResults[Tour.seriesMapIdx]=playerWon?'p':'ai';
    if(playerWon)Tour.seriesWinsP++;else Tour.seriesWinsAI++;
    this._updateSeriesBar();

    // æ›´æ–°æŒ‰é’®æ–‡å­—
    const bo=Tour.currentBo(),need=Math.ceil(bo/2);
    const seriesDone=Tour.seriesWinsP>=need||Tour.seriesWinsAI>=need;
    const nextBtn=document.getElementById('next-map-btn');
    if(nextBtn)nextBtn.innerText=seriesDone?'æŸ¥çœ‹ç³»åˆ—èµ›ç»“æœ â”':'ä¸‹ä¸€å¼ å›¾ â”';

    UI.renderPostStats(s);
  },

  exit(){
    const bo=Tour.currentBo(),winsNeeded=Math.ceil(bo/2);
    if(Tour.seriesWinsP>=winsNeeded||Tour.seriesWinsAI>=winsNeeded){
      // ç³»åˆ—èµ›ç»“æŸ
      const seriesPlayerWon=Tour.seriesWinsP>=winsNeeded;
      const m=Tour.rounds[Tour.playerRound][Tour.playerMatchIdx];
      const playerTeam=m.t1.isPlayer?m.t1:m.t2;
      const aiTeam=m.t1.isPlayer?m.t2:m.t1;
      m.winner=seriesPlayerWon?playerTeam:aiTeam;

      const postStats=document.getElementById('post-stats');
      const pnlLive=document.getElementById('pnl-live');
      if(postStats)postStats.classList.add('hidden');
      if(pnlLive)pnlLive.classList.add('hidden');

      if(seriesPlayerWon)Tour._advWin(playerTeam);
      else Tour._advLoss(aiTeam); // ã€ä¿®å¤ã€‘åªä¼ 1ä¸ªå‚æ•°
    }else{
      // ç»§ç»­ä¸‹ä¸€å¼ å›¾
      Tour.seriesMapIdx++;
      const postStats=document.getElementById('post-stats');
      const matchlog=document.getElementById('matchlog');
      const liveCtrl=document.getElementById('live-ctrl');
      const otInd=document.getElementById('ot-ind');
      if(postStats)postStats.classList.add('hidden');
      if(matchlog)matchlog.innerHTML='';
      if(liveCtrl)liveCtrl.classList.remove('hidden');
      if(otInd)otInd.classList.add('hidden');
      this._startMap(Tour.seriesMapIdx);
    }
  }
};

// â”€â”€â”€ UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const UI={
  page(id){
    document.querySelectorAll('.main>div').forEach(p=>p.classList.add('hidden'));
    const pg=document.getElementById('page-'+id);if(pg)pg.classList.remove('hidden');
    document.querySelectorAll('.nav').forEach(b=>b.classList.remove('on'));
    const navMap={home:0,schedule:1,market:2,match:3,hall:4};
    if(navMap[id]!=null){const navBtns=document.querySelectorAll('.nav');if(navBtns[navMap[id]])navBtns[navMap[id]].classList.add('on');}
    if(id==='schedule')this.renderCal();
    if(id==='hall')this.renderHall();
  },

  renderHall(){
    const t=Game.trophies||[];
    const el=document.getElementById('trophy-case');if(!el)return;
    if(!t.length){el.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--dim)">æš‚æ— è£èª‰ï¼Œè¯·åŠªåŠ›å¤ºå† ï¼</div>';return;}
    el.innerHTML=t.map(x=>`<div class="card" style="text-align:center;border-color:var(--gold-dim)">
      <div style="font-size:32px;margin-bottom:10px">ğŸ†</div>
      <div style="color:var(--gold);font-weight:700;font-size:15px;margin-bottom:4px">${x.event}</div>
      <div style="color:var(--dim);font-size:12px">${x.date?new Date(x.date).getFullYear():'Unknown'}</div>
      <div style="color:#86efac;font-size:13px;margin-top:6px">å¥–é‡‘ $${(x.prize||0).toLocaleString()}</div>
    </div>`).join('');
  },

  showPlayer(id){
    const p=World.players.find(x=>x.id===id);if(!p)return;
    const careerName=document.getElementById('career-name');
    if(careerName)careerName.innerHTML=`${p.name} <span style="font-size:14px;color:var(--dim)">ç”Ÿæ¶¯æ•°æ®</span>`;
    const protoEl=document.getElementById('career-proto');
    if(protoEl){
      if(p.isReal&&(p.realName||p.handle||p.country)){
        protoEl.classList.remove('hidden');
        protoEl.innerHTML=`<div style="font-size:11px;color:var(--gold);margin-bottom:6px">ğŸ“œ å†å²åŸå‹</div>
          è¯¥é€‰æ‰‹å¯¹åº”ç°å®ä¸­çš„ <b style="color:#fff">${p.handle||p.name}</b>ï¼ˆ${p.realName||'â€”'}ï¼‰ï¼Œ${p.country||'â€”'}ç±ã€‚`;
      }else{protoEl.classList.add('hidden');}
    }
    const tbody=document.getElementById('career-table');
    if(tbody){
      const rows=(p.history||[]).map(c=>`<tr>
        <td>${c.year}</td>
        <td style="color:${c.team==='æˆ‘çš„æˆ˜é˜Ÿ'?'var(--win)':'#fff'}">${c.team}</td>
        <td style="${c.rating>=1.15?'color:var(--win)':c.rating<0.9?'color:var(--loss)':''}">${c.rating}</td>
        <td style="${c.mvps>0?'color:var(--mvp)':''}">${c.mvps||'-'}</td>
      </tr>`).join('');
      const curM=Math.max(1,p.ys.matches);const curR=curM<5?0:p.ys.ratingSum/curM;
      tbody.innerHTML=rows+`<tr style="background:rgba(255,255,255,0.05)">
        <td>${Game.date.getFullYear()} (è¿›è¡Œä¸­)</td>
        <td style="color:${p.teamId==='PLAYER'?'var(--win)':'#fff'}">${p.teamId==='PLAYER'?'æˆ‘çš„æˆ˜é˜Ÿ':(p.teamId||'FA')}</td>
        <td>${curR>0?curR.toFixed(2):'-'}</td><td>${p.ys.mvps||'-'}</td>
      </tr>`;
    }
    const modal=document.getElementById('career-modal');if(modal)modal.classList.remove('hidden');
  },

  refresh(){
    const setText=(id,v)=>{const el=document.getElementById(id);if(el)el.innerText=v;};
    const setHTML=(id,v)=>{const el=document.getElementById(id);if(el)el.innerHTML=v;};
    setText('ui-date',fmtD(Game.date));
    setText('ui-era',Game.eras[Game.era].name);
    setText('ui-money','$'+Game.money.toLocaleString());
    setText('ui-salary','-$'+Game.weeklySalary.toLocaleString());
    setText('ui-fans',Game.fans.toLocaleString());
    setText('ui-season',Game.date.getFullYear());
    const pw=Game.power(); // è¿™é‡Œä¼šæ›´æ–° synCache
    setText('ui-raw',pw.raw.toFixed(1));
    setText('ui-eff',pw.eff.toFixed(1));
    setText('ui-chem',Game.chem.toFixed(0)+'%');
    setText('ui-chem-max',Game.chemCap()+'%');
    setText('ui-fatigue',Game.fatigue+'%');
    setHTML('ui-syn',Game.synCache.msgs.join(''));
    this.renderRoster();this.renderCoach();this.renderMapPool();
  },

  renderRoster(){
    const yr=Game.date.getFullYear(),pool=MapUtils.poolForYear(yr);
    const el=document.getElementById('roster-container');if(!el)return;
    el.innerHTML=Game.roster.map(p=>{
      const myMaps=(p.maps||[]).filter(m=>pool.includes(m.map));
      const ageWarn=p.age>=32?`<div class="age-warn">âš  ${p.age}å²ï¼Œæ³¨æ„è€åŒ–</div>`:'';
      const traitBadges=(p.traits||[]).map(t=>renderTraitBadge(t)).join('');
      const rar=RARITY[p.rarity||'common'];
      const legendClass=p.isRegenLegend?'regen-legend':'';
      const nameStyle=p.rarity==='legend'||p.isRegenLegend?'color:#ffd700;font-weight:700':'';
      return`<div class="card ${legendClass}" onclick="UI.showPlayer('${p.id}')" style="cursor:pointer;border:${rar.border};${rar.shadow?`box-shadow:${rar.shadow}`:''}">
        <span class="rbadge" style="background:${ROLES[p.role].color}">${ROLES[p.role].zh}</span>
        <div class="cname" style="${nameStyle}">${p.name} <span style="font-size:10px;color:var(--dim)">(${p.age}å²)</span></div>
        <div style="margin:4px 0 6px;min-height:18px">${traitBadges}</div>
        <div class="cstat"><span>èƒ½åŠ›</span><b>${p.rating}</b></div>
        <div class="cstat"><span>æ½œåŠ›</span><b style="color:${p.potential>=85?'var(--gold)':p.potential>=75?'var(--win)':'var(--dim)'}">${p.potential}</b></div>
        <div class="cstat"><span>çŠ¶æ€</span><b>${((p.form||1)*100).toFixed(0)}%</b></div>
        ${ageWarn}
        <div class="mapbars">${myMaps.slice(0,3).map(m=>`<div class="mapbar-row"><span class="mapbar-name">${MapUtils.display(m.map)}</span><div class="mapbar-bg"><div class="mapbar-fill" style="width:${m.str}%;background:var(--win)"></div></div><span style="font-size:9px;color:var(--dim)">${m.str}</span></div>`).join('')}
        ${myMaps.length===0?'<div style="font-size:10px;color:var(--dim)">å½“å‰å›¾æ± æ— æ“…é•¿å›¾</div>':''}</div>
        <button class="btn danger full" onclick="event.stopPropagation();Game.fireP('${p.id}')">è§£é›‡</button>
      </div>`;
    }).join('');
  },

  renderCoach(){
    const c=Game.coach;
    const el=document.getElementById('coach-container');if(!el)return;
    el.innerHTML=c?`<div class="card coach-card">
      <span class="rbadge" style="background:var(--blue)">æ•™ç»ƒ</span>
      <div class="cname">${c.name} <span style="font-size:10px;color:var(--dim)">(${c.age}å²)</span></div>
      <div class="cstat"><span>æˆ˜æœ¯æ°´å¹³</span><b style="color:var(--blue)">${c.tactics}</b></div>
      <div class="cstat"><span>ç£¨åˆä¸Šé™</span><b>${Game.chemCap()}%</b></div>
      <div class="cstat"><span>BPç²¾å‡†åº¦</span><b>${Math.round(40+c.tactics*.5)}%</b></div>
      <div class="mapbars">${(c.maps||[]).slice(0,2).map(m=>`<div class="mapbar-row"><span class="mapbar-name">${MapUtils.display(m.map)}</span><div class="mapbar-bg"><div class="mapbar-fill" style="width:${m.str}%;background:var(--blue)"></div></div><span style="font-size:9px;color:var(--dim)">${m.str}</span></div>`).join('')}</div>
      <button class="btn danger full" onclick="Game.fireC()">è§£é›‡æ•™ç»ƒ</button>
    </div>`:`<div style="text-align:center;padding:20px;color:var(--dim);font-size:12px;background:var(--panel2);border:1px dashed var(--border);border-radius:7px">æš‚æ— æ•™ç»ƒ<br><span style="font-size:11px">å‰å¾€è½¬ä¼šå¸‚åœºç­¾çº¦æ•™ç»ƒ</span></div>`;
  },

  renderMapPool(){
    const yr=Game.date.getFullYear();
    const ratings=MapUtils.teamPoolRatings(Game.roster,Game.coach,yr);
    const el=document.getElementById('ui-mappool');if(!el)return;
    el.innerHTML=ratings.map(({map,str})=>{
      const cls=str>=70?'str-high':str>=55?'str-mid':'str-low';
      const col=str>=70?'var(--map-str)':str>=55?'var(--map-mid)':'var(--map-weak)';
      return`<div class="mapchip ${cls}">
        <div style="font-weight:700;font-size:12px">${MapUtils.display(map)}</div>
        <div class="maptag" style="color:${col}">${str.toFixed(0)} ${str>=70?'å¼ºåŠ¿':''}</div>
        <div class="str-bar" style="width:${str}%;background:${col}"></div>
      </div>`;
    }).join('');
  },

  renderCal(){
    const evs=Cal.evs.filter(e=>e.date>=Game.date).slice(0,12);
    const boTag=(tier,phase)=>{const f=Cal.tierFormats[tier];const bo=phase==='final'?f.finalBo:phase==='ko'?f.knockoutBo:f.groupBo;const cls=bo===1?'bo-bo1':bo===3?'bo-bo3':'bo-bo5';return`<span class="bo-tag ${cls}">${Cal.boLabel(bo)}</span>`;};
    const el=document.getElementById('cal-container');if(!el)return;
    el.innerHTML=evs.length?evs.map(e=>`<div class="cev ${e.tier==='major'?'major':e.tier==='a-tier'?'atier':'ctier'}">
      <div class="cev-date">${fmtD(e.date).substring(5)}</div>
      <div class="cev-body">
        <div class="cev-name" style="color:${e.tier==='major'?'var(--mvp)':'#fff'}">${e.name}
          ${boTag(e.tier,'group')} â†’ ${boTag(e.tier,'ko')}${e.tier==='major'?` â†’ ${boTag(e.tier,'final')}`:''}
        </div>
        <div class="cev-sub">å‡†å…¥: ${e.minFans}ç²‰ä¸ | å¥–é‡‘: $${e.prize.toLocaleString()} | é˜Ÿä¼: ${e.teams}</div>
      </div>
      <div>${e.isReg?'<button class="btn dark" disabled>å·²æŠ¥å</button>':`<button class="btn" onclick="Cal.register('${e.id}')">æŠ¥å</button>`}</div>
    </div>`).join(''):'<div style="color:var(--dim);padding:20px;text-align:center">æœ¬å¹´èµ›äº‹å·²ç»“æŸï¼Œæ¨è¿›åˆ°ä¸‹ä¸€å¹´å§</div>';
  },

  showHub(){
    this.page('match');
    ['pnl-empty','pnl-awards'].forEach(id=>{const el=document.getElementById(id);if(el)el.classList.add('hidden');});
    const pnlHub=document.getElementById('pnl-hub');if(pnlHub)pnlHub.classList.remove('hidden');
    const pnlLive=document.getElementById('pnl-live');if(pnlLive)pnlLive.classList.add('hidden');
    const ev=Tour.ev;if(!ev)return;
    const hubName=document.getElementById('hub-name');if(hubName)hubName.innerText=ev.name;
    const hubDesc=document.getElementById('hub-desc');
    if(hubDesc)hubDesc.innerText=`ğŸ† å¥–é‡‘: $${ev.prize.toLocaleString()} | é˜Ÿä¼: ${ev.teams} | æ ¼å¼: å°ç»„${Cal.boLabel(ev.fmt.groupBo)} â†’ æ·˜æ±°${Cal.boLabel(ev.fmt.knockoutBo)}${ev.tier==='major'?' â†’ å†³èµ›'+Cal.boLabel(ev.fmt.finalBo):''}`;
    this.renderBracket();this._updateHub();
  },

  _updateHub(){
    const pnl=document.getElementById('pnl-next');if(!pnl)return;
    if(Tour.phase!=='hub'||Tour.playerRound<0||Tour.playerRound>=Tour.rounds.length){pnl.classList.add('hidden');return;}
    const round=Tour.rounds[Tour.playerRound];
    const idx=Tour.playerMatchIdx;
    if(idx<0||idx>=round.length){pnl.classList.add('hidden');return;}
    const m=round[idx];
    if(!m||m.winner){pnl.classList.add('hidden');return;}
    const opp=m.t1.isPlayer?m.t2:m.t1;
    if(!opp){pnl.classList.add('hidden');return;}
    const hubOpp=document.getElementById('hub-opp');if(hubOpp)hubOpp.innerHTML=teamNameWithStar(opp.name);
    const bo=Tour.currentBo();
    const hubFormat=document.getElementById('hub-format');if(hubFormat)hubFormat.innerText=`èµ›åˆ¶: ${Cal.boLabel(bo)} | å½“å‰é˜¶æ®µ: ç¬¬${Tour.playerRound+1}è½®ï¼ˆå…±${Tour.rounds.length}è½®ï¼‰`;
    this._renderIntel(opp);
    pnl.classList.remove('hidden');
  },

  _renderIntel(opp){
    const yr=Game.date.getFullYear();
    const oppRatings=MapUtils.teamPoolRatings(opp.roster||[],opp.coach||null,yr);
    const myRatings=MapUtils.teamPoolRatings(Game.roster,Game.coach,yr);
    const sorted=[...oppRatings].sort((a,b)=>b.str-a.str);
    const top3=sorted.slice(0,3),bot2=sorted.slice(-2);
    const html=`
      <div class="intel-row"><span style="color:var(--dim)">å¯¹æ‰‹å¼ºå›¾</span><span>${top3.map(x=>`<span style="color:var(--loss);font-weight:700">${MapUtils.display(x.map)}</span>`).join(' ')}</span></div>
      <div class="intel-row"><span style="color:var(--dim)">å¯¹æ‰‹å¼±å›¾</span><span>${bot2.map(x=>`<span style="color:var(--win);font-weight:700">${MapUtils.display(x.map)}</span>`).join(' ')}</span></div>
      <div class="intel-row"><span style="color:var(--dim)">æˆ‘æ–¹å¼ºå›¾</span><span>${[...myRatings].sort((a,b)=>b.str-a.str).slice(0,3).map(x=>`<span style="color:var(--win);font-weight:700">${MapUtils.display(x.map)}</span>`).join(' ')}</span></div>
      <div class="intel-row"><span style="color:var(--dim)">å¯¹æ‰‹æˆ˜åŠ›</span><b style="color:var(--fg)">${((opp.roster||[]).reduce((s,p)=>s+(p.rating||60)*(p.form||1),0)/Math.max(1,(opp.roster||[]).length)).toFixed(1)}</b></div>
      ${opp.coach?`<div class="intel-row"><span style="color:var(--dim)">å¯¹æ‰‹æ•™ç»ƒ</span><b style="color:var(--blue)">${opp.coach.name}ï¼ˆæˆ˜æœ¯${opp.coach.tactics}ï¼‰</b></div>`:''}`;
    const ic=document.getElementById('intel-content');if(ic)ic.innerHTML=html;
  },

  renderBracket(){
    const c=document.getElementById('bracket');if(!c)return;c.innerHTML='';
    Tour.rounds.forEach(round=>{
      const col=document.createElement('div');col.className='bcol';
      round.forEach(m=>{
        const isP=m.t1?.isPlayer||m.t2?.isPlayer;
        const s1=m.winner&&m.t1?` <span class="bscore" style="color:${m.winner===m.t1?'var(--win)':'var(--loss)'}">âœ“</span>`:'';
        const s2=m.winner&&m.t2?` <span class="bscore" style="color:${m.winner===m.t2?'var(--win)':'var(--loss)'}">âœ“</span>`:'';
        col.innerHTML+=`<div class="bnode ${isP?'pnode':''}">
          <div class="bteam ${m.t1?.isPlayer?'isp':''} ${m.winner===m.t1?'won':''}">${m.t1?teamNameWithStar(m.t1.name):'ç­‰å¾…'}${s1}</div>
          <div style="font-size:9px;color:var(--dim2);text-align:center;padding:2px 0">VS</div>
          <div class="bteam ${m.t2?.isPlayer?'isp':''} ${m.winner===m.t2?'won':''}">${m.t2?teamNameWithStar(m.t2.name):'ç­‰å¾…'}${s2}</div>
        </div>`;
      });
      c.appendChild(col);
    });
  },

  showLive(){
    const pnlHub=document.getElementById('pnl-hub');if(pnlHub)pnlHub.classList.add('hidden');
    const pnlLive=document.getElementById('pnl-live');if(pnlLive)pnlLive.classList.remove('hidden');
    const postStats=document.getElementById('post-stats');if(postStats)postStats.classList.add('hidden');
    const liveCtrl=document.getElementById('live-ctrl');if(liveCtrl)liveCtrl.classList.remove('hidden');
    this.updateScore();
  },

  updateScore(){
    const s=Match.s;if(!s)return;
    const scoreA=document.getElementById('score-a');if(scoreA)scoreA.innerText=s.sA;
    const scoreB=document.getElementById('score-b');if(scoreB)scoreB.innerText=s.sB;
    const sideA=s.ctIsA?{t:'CT',c:'bct'}:{t:'T',c:'bt'};
    const sideB=s.ctIsA?{t:'T',c:'bt'}:{t:'CT',c:'bct'};
    const badgeA=document.getElementById('badge-a');if(badgeA){badgeA.className=sideA.c;badgeA.innerText=sideA.t;}
    const badgeB=document.getElementById('badge-b');if(badgeB){badgeB.className=sideB.c;badgeB.innerText=sideB.t;}
    const pistol=!s.isOT&&(s.round===0||s.round===s.era.halfR);
    const bA=Match.buyStatus(s.monA,pistol,s.isOT),bB=Match.buyStatus(s.monB,pistol,s.isOT);
    const cls=x=>x.lvl==='Eco'?'style="color:var(--loss)"':x.lvl==='Force'?'style="color:var(--gold)"':'style="color:var(--win)"';
    const ecoA=document.getElementById('eco-a');if(ecoA)ecoA.innerHTML=`$${s.monA} | è¿è´¥${s.lsA} <span ${cls(bA)}>[${bA.name}]</span>`;
    const ecoB=document.getElementById('eco-b');if(ecoB)ecoB.innerHTML=`$${s.monB} | è¿è´¥${s.lsB} <span ${cls(bB)}>[${bB.name}]</span>`;
  },

  log(msg,type,style=''){
    const l=document.getElementById('matchlog');if(!l)return;
    const d=document.createElement('div');d.className=`mlog-e ${type}`;
    if(style)d.style=style;d.innerHTML=msg;l.appendChild(d);l.scrollTop=l.scrollHeight;
  },

  renderPostStats(s){
    const el=document.getElementById('post-stats');if(!el)return;
    el.classList.remove('hidden');
    const row=p=>{
      const isMvp=p===s.mvp,isEvp=(s.evps||[]).includes(p);
      const b=isMvp?`<span class="bmvp">MVP</span>`:isEvp?`<span class="bevp">EVP</span>`:'';
      const cl=p.rating2>=1.15?'g':p.rating2<.9?'r':'';
      return`<tr><td>${p.name}${b}</td><td>${p.kills}-${p.deaths}</td><td>${p.assists}</td><td>${p.adr}</td><td>${p.kast}%</td><td>${p.impact}</td><td class="${cl}">${p.rating2}</td></tr>`;
    };
    const hd=`<tr><th>Player</th><th>K-D</th><th>A</th><th>ADR</th><th>KAST</th><th>Imp.</th><th>Rating</th></tr>`;
    const tblA=document.getElementById('tbl-a');if(tblA)tblA.innerHTML=hd+(s.tA||[]).map(row).join('');
    const tblB=document.getElementById('tbl-b');if(tblB)tblB.innerHTML=hd+(s.tB||[]).map(row).join('');
    const tblBHdr=document.getElementById('tbl-b-hdr');if(tblBHdr)tblBHdr.innerHTML=`ğŸ”« ${teamNameWithStar(s.opp.name)}`;
    const bo=Tour.currentBo(),need=Math.ceil(bo/2);
    const awards=document.getElementById('match-awards');
    if(awards)awards.innerHTML=`<div><span style="color:var(--mvp);font-weight:700">â­ Match MVP:</span> <b style="color:#fff;font-size:15px">${s.mvp?s.mvp.name:'â€”'}</b> <span style="font-size:11px;color:var(--dim);margin-left:8px">${s.mvp?`Rating:${s.mvp.rating2} ADR:${s.mvp.adr} Impact:${s.mvp.impact}`:''}</span></div>
      <div style="margin-top:6px;font-size:11px;color:var(--dim)">ç³»åˆ—èµ›: æˆ‘æ–¹ <b style="color:var(--win)">${Tour.seriesWinsP}</b> - <b style="color:var(--loss)">${Tour.seriesWinsAI}</b> å¯¹æ–¹ | è¿˜éœ€ <b style="color:var(--gold)">${Math.max(0,need-Math.max(Tour.seriesWinsP,Tour.seriesWinsAI))}</b> èƒœç»“æŸ</div>`;
    setTimeout(()=>{const live=document.getElementById('pnl-live');if(live)live.scrollTo({top:1000,behavior:'smooth'});},100);
  },

  renderAwards(mvp,evps,champ,rank,prize){
    ['pnl-hub','pnl-live'].forEach(id=>{const el=document.getElementById(id);if(el)el.classList.add('hidden');});
    const pnlAwards=document.getElementById('pnl-awards');if(pnlAwards)pnlAwards.classList.remove('hidden');
    const awardsSub=document.getElementById('awards-sub');
    if(awardsSub)awardsSub.innerHTML=`
      <div style="display:inline-block;padding:9px 18px;background:rgba(34,197,94,.08);border-radius:6px;color:#86efac;margin-right:12px;border:1px solid rgba(34,197,94,.2)">ğŸ‘‘ å† å†›: <b style="color:#fff;font-size:17px">${champ.name}</b> ${isRealTeam(champ.name)?'<span style="color:#ffd700">â­</span>':''}</div>
      <div style="display:inline-block;padding:9px 18px;background:var(--panel2);border-radius:6px;color:var(--dim);border:1px solid var(--border)">åæ¬¡: <b style="color:var(--gold);font-size:15px">${rank}</b> | å¥–é‡‘: <b style="color:#86efac;font-size:15px">$${prize.toLocaleString()}</b></div>`;
    const awardsMvp=document.getElementById('awards-mvp');
    if(awardsMvp)awardsMvp.innerHTML=mvp?`<div class="arow mvp-row">
      <div>
        <div style="font-size:11px;color:var(--mvp);font-weight:700;margin-bottom:3px">ğŸ… èµ›äº‹ MVP</div>
        <div style="font-size:20px;font-weight:800;color:#fff">â­ ${mvp.player.name} <span style="font-size:11px;color:var(--dim);font-weight:400">[${mvp.team.name}]</span></div>
      </div>
      <div style="text-align:right;font-size:12px;color:var(--dim);line-height:1.8">
        <div>ç»¼åˆå¾—åˆ† <b style="color:var(--mvp)">${mvp.avgScore.toFixed(2)}</b></div>
        <div>æœ€é«˜Rating <b style="color:#fff">${typeof mvp.topRating==='number'?mvp.topRating.toFixed(2):mvp.topRating}</b></div>
      </div>
    </div>`:'<div style="color:var(--dim);padding:12px">æš‚æ— MVPæ•°æ®</div>';
    const awardsEvp=document.getElementById('awards-evp');
    if(awardsEvp)awardsEvp.innerHTML=(evps||[]).map(e=>`<div class="arow evp-row">
      <div style="font-size:14px;font-weight:700;color:#eee">ğŸ– ${e.player.name} <span style="font-size:10px;color:var(--dim)">[${e.team.name}]</span></div>
      <div style="font-size:11px;color:var(--dim)">å¾—åˆ† <b style="color:var(--evp)">${e.avgScore.toFixed(2)}</b> | åœºæ¬¡ ${e.played}</div>
    </div>`).join('');
  },

  showEventTicker(msg){
    let t=document.querySelector('.event-ticker');
    if(t){clearTimeout(t._timer);t.remove();}
    t=document.createElement('div');t.className='event-ticker';t.innerText='ğŸ“° '+msg;
    document.body.appendChild(t);t._timer=setTimeout(()=>t.remove(),5000);
  },

  toast(msg){
    let t=document.querySelector('.toast');if(t)t.remove();
    t=document.createElement('div');t.className='toast';t.innerText=msg;
    document.body.appendChild(t);setTimeout(()=>t.remove(),3500);
  }
};

window.onload=()=>Game.init();
</script>
</body>
</html>
